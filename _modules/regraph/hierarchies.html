
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>regraph.hierarchies &#8212; ReGraph 3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for regraph.hierarchies</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Abstract hierarchies of graphs in ReGraph.</span>

<span class="sd">This module contains abstact data structures for</span>
<span class="sd">graph hierarchies. A graph hierarchy is a DAG, whose nodes</span>
<span class="sd">are graphs and whose directed edges represent</span>
<span class="sd">homomorphisms between graphs. In addition, hierarchies are</span>
<span class="sd">equipped with relations on graphs (which can be thought of as</span>
<span class="sd">undirected edges or, alternatively, spans).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">regraph.exceptions</span> <span class="k">import</span> <span class="p">(</span><span class="n">HierarchyError</span><span class="p">,</span>
                                <span class="n">ReGraphError</span><span class="p">,</span>
                                <span class="n">InvalidHomomorphism</span><span class="p">,</span>
                                <span class="n">RewritingError</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">regraph.category_utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">compose</span><span class="p">,</span>
                                    <span class="n">check_homomorphism</span><span class="p">,</span>
                                    <span class="n">relation_to_span</span><span class="p">,</span>
                                    <span class="n">pushout</span><span class="p">,</span>
                                    <span class="n">get_unique_map_to_pullback</span><span class="p">,</span>
                                    <span class="n">get_unique_map_from_pushout</span><span class="p">,</span>
                                    <span class="n">is_monic</span><span class="p">,</span>
                                    <span class="n">pullback</span><span class="p">,</span>
                                    <span class="n">image_factorization</span><span class="p">,</span>
                                    <span class="n">get_unique_map_to_pullback_complement</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">regraph.rules</span> <span class="k">import</span> <span class="n">Rule</span>
<span class="kn">from</span> <span class="nn">regraph.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">attrs_from_json</span><span class="p">,</span>
                           <span class="n">attrs_to_json</span><span class="p">,</span>
                           <span class="n">keys_by_value</span><span class="p">,</span>
                           <span class="n">normalize_typing_relation</span><span class="p">,</span>
                           <span class="n">test_strictness</span><span class="p">)</span>


<div class="viewcode-block" id="Hierarchy"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy">[docs]</a><span class="k">class</span> <span class="nc">Hierarchy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for graph hierarchy objects in ReGraph.</span>

<span class="sd">    A graph hierarchy is a DAG, where nodes are graphs with attributes and</span>
<span class="sd">    edges are homomorphisms representing graph typing in the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Hierarchy.graphs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.graphs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of graphs in the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.typings"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.typings">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">typings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of graph typing edges in the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.relations"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relations">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of relations.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.successors"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.successors">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of successors.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.predecessors"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.predecessors">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of predecessors.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a graph object associated to the node &#39;graph_id&#39;.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_typing"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_typing">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a typing dict associated to the edge &#39;source_id-&gt;target_id&#39;.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_relation"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_relation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_id</span><span class="p">,</span> <span class="n">right_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a relation dict associated to the rel &#39;left_id-&gt;target_id&#39;.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_graph_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_graph_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_graph_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.set_graph_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.set_graph_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_graph_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_typing_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_typing_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_typing_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a typing in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.set_typing_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.set_typing_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_typing_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a typing in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.get_relation_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_relation_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_relation_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a reltion in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left : hashable</span>
<span class="sd">            Id of the left graph</span>
<span class="sd">        right : hashable</span>
<span class="sd">            Id of the right graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.set_relation_attrs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.set_relation_attrs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_relation_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a relation in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left : hashable</span>
<span class="sd">            Id of the left graph</span>
<span class="sd">        right : hashable</span>
<span class="sd">            Id of the right graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.set_node_relation"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.set_node_relation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_node_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_graph</span><span class="p">,</span> <span class="n">right_graph</span><span class="p">,</span> <span class="n">left_node</span><span class="p">,</span>
                          <span class="n">right_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set relation for a particular node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.add_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">add_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new graph to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        graph : regraph.Graph</span>
<span class="sd">            Graph object corresponding to the new node of</span>
<span class="sd">            the hierarchy</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.add_graph_from_data"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_graph_from_data">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">add_graph_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">edge_list</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new graph to the hierarchy from the input node/edge lists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        node_list : iterable</span>
<span class="sd">            List of nodes (with attributes)</span>
<span class="sd">        edge_list : iterable</span>
<span class="sd">            List of edges (with attributes)</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.add_empty_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_empty_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">add_empty_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Add a new empty graph to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.add_typing"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_typing">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">add_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add homomorphism to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph node of typing</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph node of typing</span>
<span class="sd">        mapping : dict</span>
<span class="sd">            Dictionary representing a mapping of nodes</span>
<span class="sd">            from the source graph to target&#39;s nodes</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            Dictionary containing attributes of the new</span>
<span class="sd">            typing edge</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            This error is raised in the following cases:</span>

<span class="sd">                * source or target ids are not found in the hierarchy</span>
<span class="sd">                * a typing edge between source and target already exists</span>
<span class="sd">                * addition of an edge between source and target creates</span>
<span class="sd">                a cycle or produces paths that do not commute with</span>
<span class="sd">                some already existing paths</span>

<span class="sd">        InvalidHomomorphism</span>
<span class="sd">            If a homomorphisms from a graph at the source to a graph at</span>
<span class="sd">            the target given by `mapping` is not a valid homomorphism.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.add_relation"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_relation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">add_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add relation to the hierarchy.</span>

<span class="sd">        This method adds a relation between two graphs in</span>
<span class="sd">        the hierarchy corresponding to the nodes with ids</span>
<span class="sd">        `left` and `right`, the relation itself is defined</span>
<span class="sd">        by a dictionary `relation`, where a key is a node in</span>
<span class="sd">        the `left` graph and its corresponding value is a set</span>
<span class="sd">        of nodes from the `right` graph to which the node is</span>
<span class="sd">        related. Relations in the hierarchy are symmetric</span>
<span class="sd">        (see example below).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `left` graph</span>
<span class="sd">        right</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `right` graph</span>
<span class="sd">        relation : dict</span>
<span class="sd">            Dictionary representing a relation of nodes from `left`</span>
<span class="sd">            to the nodes from `right`, a key of the dictionary is</span>
<span class="sd">            assumed to be a node from `left` and its value a set</span>
<span class="sd">            of ids of related nodes from `right`</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            Dictionary containing attributes of the new relation</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            This error is raised in the following cases:</span>

<span class="sd">                * node with id `left`/`right` is not defined in the hierarchy;</span>
<span class="sd">                * node with id `left`/`right` is not a graph;</span>
<span class="sd">                * a relation between `left` and `right` already exists;</span>
<span class="sd">                * some node ids specified in `relation` are not found in the</span>
<span class="sd">                `left`/`right` graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.remove_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.remove_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">remove_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove graph from the hierarchy.</span>

<span class="sd">        Removes a graph from the hierarchy, if the `reconnect`</span>
<span class="sd">        parameter is set to True, adds typing from the</span>
<span class="sd">        predecessors of the removed node to all its successors,</span>
<span class="sd">        by composing the homomorphisms (for every predecessor `p`</span>
<span class="sd">        and for every successor &#39;s&#39; composes two homomorphisms</span>
<span class="sd">        `p`-&gt;`node_id` and `node_id`-&gt;`s`, then removes `node_id` and</span>
<span class="sd">        all its incident edges, by which makes node&#39;s</span>
<span class="sd">        removal a procedure of &#39;forgetting&#39; one level</span>
<span class="sd">        of &#39;abstraction&#39;).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node_id</span>
<span class="sd">            Id of a graph to remove</span>
<span class="sd">        reconnect : bool</span>
<span class="sd">            Reconnect the descendants of the removed node to</span>
<span class="sd">            its predecessors</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If graph with `node_id` is not defined in the hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.remove_typing"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.remove_typing">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">remove_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a typing from the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.remove_relation"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.remove_relation">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">remove_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a relation from the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.bfs_tree"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.bfs_tree">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">bfs_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;BFS tree from the graph to all other reachable graphs.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.shortest_path"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.shortest_path">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shortest path from &#39;source&#39; to &#39;target&#39;.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.copy_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.copy_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">copy_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">,</span> <span class="n">attach_graphs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Create a copy of a graph in a hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.relabel_graph_node"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relabel_graph_node">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">relabel_graph_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename a node in a graph of the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.relabel_graph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relabel_graph">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">relabel_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph to relabel</span>
<span class="sd">        new_graph_id : hashable</span>
<span class="sd">            New graph id to assign to this graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.relabel_graphs"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relabel_graphs">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">relabel_graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel graphs in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mapping: dict</span>
<span class="sd">            A dictionary with keys being old graph ids and their values</span>
<span class="sd">            being new id&#39;s of the respective graphs.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ReGraphError</span>
<span class="sd">            If new id&#39;s do not define a set of distinct graph id&#39;s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_update_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the mapping dictionary from source to target.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_update_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the relation dictionaries (left and right).&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Implemented methods</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation of the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Graphs:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Typing homomorphisms: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Relations:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hierarchy equality test.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="o">!=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">get_graph_attrs</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="o">!=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">get_typing_attrs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">relations</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">relations</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="o">!=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">get_relation_attrs</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-equality operator.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">hierarchy</span><span class="p">)</span>

<div class="viewcode-block" id="Hierarchy.add_graph_from_json"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.add_graph_from_json">[docs]</a>    <span class="k">def</span> <span class="nf">add_graph_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new graph to the hirarchy from its JSON-reprsentation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the new graph</span>
<span class="sd">        json_data : dict</span>
<span class="sd">            JSON-like dictionary containing the representation of the graph</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            Attributes to attach to the new graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edge_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]:</span>
            <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
            <span class="n">edge_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_graph_from_data</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">edge_list</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hierarchy.to_json"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rename_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return json representation of the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rename_nodes : dict, optional</span>
<span class="sd">            Dictionary specifying mapping of node ids</span>
<span class="sd">            from the original graph to its JSON-representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;graphs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;relations&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rename_nodes</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rename_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="n">rename_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="n">node</span>

            <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
                <span class="s2">&quot;graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="n">attrs_to_json</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rename_nodes</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rename_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">s_id</span> <span class="o">=</span> <span class="n">rename_nodes</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_id</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">rename_nodes</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rename_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">t_id</span> <span class="o">=</span> <span class="n">rename_nodes</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_id</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">s_id</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">t_id</span><span class="p">,</span>
                <span class="s2">&quot;mapping&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="n">attrs_to_json</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rename_nodes</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">rename_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="n">rename_nodes</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="n">u</span>
            <span class="k">if</span> <span class="n">rename_nodes</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">v_id</span> <span class="o">=</span> <span class="n">rename_nodes</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_id</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">visited</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">u_id</span><span class="p">,</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">v_id</span><span class="p">,</span>
                    <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">a</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="n">attrs_to_json</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">json_data</span></div>

<div class="viewcode-block" id="Hierarchy.from_json"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a hierarchy object from JSON-representation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_data : dict</span>
<span class="sd">            JSON-like dict containing representation of a hierarchy</span>
<span class="sd">        ignore : dict, optional</span>
<span class="sd">            Dictionary containing components to ignore in the process</span>
<span class="sd">            of converting from JSON, dictionary should respect the</span>
<span class="sd">            following format:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;graphs&quot;: &lt;collection of ids of graphs to ignore&gt;,</span>
<span class="sd">                &quot;rules&quot;: &lt;collection of ids of rules to ignore&gt;,</span>
<span class="sd">                &quot;typing&quot;: &lt;collection of tuples containing typing</span>
<span class="sd">                    edges to ignore&gt;,</span>
<span class="sd">                &quot;rule_typing&quot;: &lt;collection of tuples containing rule</span>
<span class="sd">                    typing edges to ignore&gt;&gt;,</span>
<span class="sd">                &quot;relations&quot;: &lt;collection of tuples containing</span>
<span class="sd">                    relations to ignore&gt;,</span>
<span class="sd">            }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hierarchy : regraph.hierarchies.Hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hierarchy</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>

        <span class="c1"># add graphs</span>
        <span class="k">for</span> <span class="n">graph_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;graphs&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph_from_json</span><span class="p">(</span>
                    <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># add typing</span>
        <span class="k">for</span> <span class="n">typing_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;typing&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span> <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">typing_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;mapping&quot;</span><span class="p">],</span>
                    <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># add relations</span>
        <span class="k">for</span> <span class="n">relation_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]:</span>
            <span class="n">from_g</span> <span class="o">=</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
            <span class="n">to_g</span> <span class="o">=</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;relations&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="p">((</span><span class="n">from_g</span><span class="p">,</span> <span class="n">to_g</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">to_g</span><span class="p">,</span> <span class="n">from_g</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">relation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">from_g</span><span class="p">,</span> <span class="n">to_g</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">relations</span><span class="p">():</span>
                    <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_relation</span><span class="p">(</span>
                        <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span>
                        <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span>
                        <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;rel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                        <span class="n">attrs</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">hierarchy</span></div>

<div class="viewcode-block" id="Hierarchy.load"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the hierarchy from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Path to the file containing JSON-representation of the hierarchy</span>
<span class="sd">        ignore : dict</span>
<span class="sd">            Dictionary with graph elemenets to ignore when loading</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hierarchy : regraph.hierarchies.Hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">hierarchy</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hierarchy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReGraphError</span><span class="p">(</span><span class="s2">&quot;File &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>

<div class="viewcode-block" id="Hierarchy.export"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the hierarchy to a file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">j_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">j_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hierarchy.adjacent_relations"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.adjacent_relations">[docs]</a>    <span class="k">def</span> <span class="nf">adjacent_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of related graphs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Graph node &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist in the hierarchy!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">r</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">g</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">l</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">g</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="Hierarchy.node_type"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.node_type">[docs]</a>    <span class="k">def</span> <span class="nf">node_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of the immediate types of a node.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">graph_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Graph &#39;</span><span class="si">{}</span><span class="s2">&#39; is not defined in the hierarchy!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Graph &#39;</span><span class="si">{}</span><span class="s2">&#39;&#39; does not have a node with id &#39;</span><span class="si">{}</span><span class="s2">&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">types</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">types</span></div>

<div class="viewcode-block" id="Hierarchy.get_ancestors"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_ancestors">[docs]</a>    <span class="k">def</span> <span class="nf">get_ancestors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ancestors of a graph with the typing morphisms.&quot;&quot;&quot;</span>
        <span class="n">ancestors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
            <span class="n">typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
            <span class="n">pred_ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ancestors</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ancestors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pred_ancestors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ancestors</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">=</span> <span class="n">typing</span>
            <span class="k">for</span> <span class="n">anc</span><span class="p">,</span> <span class="n">anc_typing</span> <span class="ow">in</span> <span class="n">pred_ancestors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">ancestors</span><span class="p">[</span><span class="n">anc</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compose</span><span class="p">(</span><span class="n">anc_typing</span><span class="p">,</span> <span class="n">typing</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ancestors</span><span class="p">[</span><span class="n">anc</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">anc_typing</span><span class="p">,</span> <span class="n">typing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ancestors</span></div>

<div class="viewcode-block" id="Hierarchy.get_descendants"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_descendants">[docs]</a>    <span class="k">def</span> <span class="nf">get_descendants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">maybe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return descendants of a graph with the typing morphisms.&quot;&quot;&quot;</span>
        <span class="n">descendants</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
            <span class="n">typing_descendants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">successor</span><span class="p">,</span> <span class="n">maybe</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">descendants</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">descendants</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">descendants</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>
            <span class="k">for</span> <span class="n">anc</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">typing_descendants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">anc</span> <span class="ow">in</span> <span class="n">descendants</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">descendants</span><span class="p">[</span><span class="n">anc</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compose</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">typ</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">descendants</span><span class="p">[</span><span class="n">anc</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">descendants</span></div>

<div class="viewcode-block" id="Hierarchy.compose_path_typing"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.compose_path_typing">[docs]</a>    <span class="k">def</span> <span class="nf">compose_path_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compose homomorphisms along the path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : list</span>
<span class="sd">            List of nodes of the hierarchy forming a path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        If source node of the path is a graph</span>

<span class="sd">        homomorphism : dict</span>
<span class="sd">            Dictionary containg the typing of the nodes</span>
<span class="sd">            from the source graph of the path by the nodes</span>
<span class="sd">            of the target graph</span>

<span class="sd">        if source node of the path is a rule</span>

<span class="sd">        lhs_homomorphism : dict</span>
<span class="sd">            Dictionary containg the typing of the nodes</span>
<span class="sd">            from the left-hand side of the source rule</span>
<span class="sd">            of the path by the nodes of the target graph</span>
<span class="sd">        rhs_homomorphism : dict</span>
<span class="sd">            Dictionary containg the typing of the nodes</span>
<span class="sd">            from the right-hand side of the source rule</span>
<span class="sd">            of the path by the nodes of the target graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">homomorphism</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">homomorphism</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span>
                <span class="n">homomorphism</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">homomorphism</span></div>

<div class="viewcode-block" id="Hierarchy.get_rule_hierarchy"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.get_rule_hierarchy">[docs]</a>    <span class="k">def</span> <span class="nf">get_rule_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">p_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find rule hierarchy corresponding to the input rewriting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph to rewrite</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Rewriting rule</span>
<span class="sd">        instance : dict, optional</span>
<span class="sd">            Instance of the rule in the graph. If not specified,</span>
<span class="sd">            the identity of the left-hand side is used</span>
<span class="sd">        p_typing : dict</span>
<span class="sd">            Relations controlling backward propagation. The keys are</span>
<span class="sd">            ancestors of the rewritten graph, values are dictionaries</span>
<span class="sd">            containing individual relations between the nodes of a given</span>
<span class="sd">            ancestor and the preserved part of the rule</span>
<span class="sd">        rhs_typing : dict</span>
<span class="sd">            Relation controlling forward propagation. The keys are</span>
<span class="sd">            descendants of the rewritten graph, values are dictionaries</span>
<span class="sd">            containing individual relations between the right-hand</span>
<span class="sd">            side of the rule and the nodes of a given</span>
<span class="sd">            descendant</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rule_hierarchy : dictionary</span>
<span class="sd">            Dictionary contains two keys: (1) `rules` whose value is</span>
<span class="sd">            a dictionary with id&#39;s of the graphs in the hierarchy and</span>
<span class="sd">            the computed propagation rules; (2) `rule_homomorphisms` whose</span>
<span class="sd">            value is a dictionary with pairs of graphs in the hierarchy and</span>
<span class="sd">            the computed homomorphisms between rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rule_instance_typing</span><span class="p">(</span>
            <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">instances</span> <span class="o">=</span> <span class="p">{</span><span class="n">origin_id</span><span class="p">:</span> <span class="n">instance</span><span class="p">}</span>
        <span class="n">rule_hierarchy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">origin_id</span><span class="p">:</span> <span class="n">rule</span><span class="p">},</span>
            <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="c1"># Compute rules and their map to the original rule</span>
        <span class="n">l_g_ls</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># LHS&#39;s of rule liftings to LHS of the original rule</span>
        <span class="n">p_g_ps</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># interfaces of rule liftings to LHS of the original rule</span>

        <span class="n">ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ancestors</span><span class="p">(</span><span class="n">origin_id</span><span class="p">)</span>
        <span class="n">descendants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">origin_id</span><span class="p">)</span>

        <span class="c1"># Compute rule liftings</span>
        <span class="k">for</span> <span class="n">ancestor</span><span class="p">,</span> <span class="n">origin_typing</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Compute L_G</span>
            <span class="n">l_g</span><span class="p">,</span> <span class="n">l_g_g</span><span class="p">,</span> <span class="n">l_g_l</span> <span class="o">=</span> <span class="n">pullback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">ancestor</span><span class="p">),</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">origin_id</span><span class="p">),</span>
                <span class="n">origin_typing</span><span class="p">,</span>
                <span class="n">instance</span><span class="p">)</span>

            <span class="c1"># Compute canonical P_G</span>
            <span class="n">canonical_p_g</span><span class="p">,</span> <span class="n">p_g_l_g</span><span class="p">,</span> <span class="n">p_g_p</span> <span class="o">=</span> <span class="n">pullback</span><span class="p">(</span>
                <span class="n">l_g</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">l_g_l</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">)</span>

            <span class="c1"># Remove controlled things from P_G</span>
            <span class="k">if</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">l_g_factorization</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">keys_by_value</span><span class="p">(</span><span class="n">l_g_g</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">p_g_nodes_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">canonical_p_g</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="n">l_g_node</span> <span class="o">=</span> <span class="n">p_g_l_g</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                    <span class="c1"># If corresponding L_G node is specified in</span>
                    <span class="c1"># the controlling relation, remove all</span>
                    <span class="c1"># the instances of P nodes not mentioned</span>
                    <span class="c1"># in this relations</span>
                    <span class="k">if</span> <span class="n">l_g_node</span> <span class="ow">in</span> <span class="n">l_g_factorization</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">p_nodes</span> <span class="o">=</span> <span class="n">l_g_factorization</span><span class="p">[</span><span class="n">l_g_node</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">p_g_p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">p_g_p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">p_g_l_g</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                            <span class="n">p_g_nodes_to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">p_g_nodes_to_remove</span><span class="p">:</span>
                    <span class="n">canonical_p_g</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span>\
                <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">canonical_p_g</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">l_g</span><span class="p">,</span> <span class="n">p_lhs</span><span class="o">=</span><span class="n">p_g_l_g</span><span class="p">)</span>

            <span class="n">instances</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_g_g</span>
            <span class="n">l_g_ls</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_g_l</span>
            <span class="n">p_g_ps</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_g_p</span>

        <span class="n">l_l_ts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Original rule LHS to the LHS of rule projections</span>
        <span class="n">p_p_ts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Original rule interface to the inter. of rule projections</span>
        <span class="n">r_r_ts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Original rule RHS to the RHS of rule projections</span>

        <span class="c1"># Compute rule projections</span>
        <span class="k">for</span> <span class="n">descendant</span><span class="p">,</span> <span class="n">origin_typing</span> <span class="ow">in</span> <span class="n">descendants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Compute canonical P_T</span>
            <span class="n">l_t</span><span class="p">,</span> <span class="n">l_l_t</span><span class="p">,</span> <span class="n">l_t_t</span> <span class="o">=</span> <span class="n">image_factorization</span><span class="p">(</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">descendant</span><span class="p">),</span>
                <span class="n">compose</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">origin_typing</span><span class="p">))</span>

            <span class="c1"># Compute canonical R_T</span>
            <span class="n">r_t</span><span class="p">,</span> <span class="n">l_t_r_t</span><span class="p">,</span> <span class="n">r_r_t</span> <span class="o">=</span> <span class="n">pushout</span><span class="p">(</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">l_t</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span>
                <span class="n">compose</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span> <span class="n">l_l_t</span><span class="p">),</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">)</span>

            <span class="c1"># Modify P_T and R_T according to the controlling</span>
            <span class="c1"># relation rhs_typing</span>
            <span class="k">if</span> <span class="n">descendant</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">r_t_factorization</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">r_r_t</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">added_t_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">r_t</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">r_t_factorization</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># If corresponding R_T node is specified in</span>
                        <span class="c1"># the controlling relation add nodes of T</span>
                        <span class="c1"># that type it to P</span>
                        <span class="n">t_nodes</span> <span class="o">=</span> <span class="n">r_t_factorization</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">t_node</span> <span class="ow">in</span> <span class="n">t_nodes</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">t_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_t_t</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">t_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added_t_nodes</span><span class="p">:</span>
                                <span class="n">new_p_node</span> <span class="o">=</span> <span class="n">l_t</span><span class="o">.</span><span class="n">generate_new_node_id</span><span class="p">(</span>
                                    <span class="n">t_node</span><span class="p">)</span>
                                <span class="n">l_t</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">new_p_node</span><span class="p">)</span>
                                <span class="n">added_t_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t_node</span><span class="p">)</span>
                                <span class="n">l_t_r_t</span><span class="p">[</span><span class="n">new_p_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                                <span class="n">l_t_t</span><span class="p">[</span><span class="n">new_p_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_node</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">l_t_r_t</span><span class="p">[</span><span class="n">keys_by_value</span><span class="p">(</span><span class="n">l_t_t</span><span class="p">,</span> <span class="n">t_node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">n</span>

            <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span>\
                <span class="n">Rule</span><span class="p">(</span><span class="n">lhs</span><span class="o">=</span><span class="n">l_t</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">l_t</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">r_t</span><span class="p">,</span> <span class="n">p_rhs</span><span class="o">=</span><span class="n">l_t_r_t</span><span class="p">)</span>

            <span class="n">instances</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_t_t</span>
            <span class="n">l_l_ts</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_l_t</span>
            <span class="n">p_p_ts</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">l_l_t</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">r_r_ts</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_r_t</span>

        <span class="c1"># Compute homomorphisms between rules</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">graph_rule</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">graph_id</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                    <span class="n">old_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">successor</span> <span class="o">==</span> <span class="n">origin_id</span><span class="p">:</span>
                        <span class="n">graph_lhs_successor_lhs</span> <span class="o">=</span> <span class="n">l_g_ls</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
                        <span class="n">graph_p_successor_p</span> <span class="o">=</span> <span class="n">p_g_ps</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
                        <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                            <span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">graph_lhs_successor_lhs</span><span class="p">,</span>
                                <span class="n">graph_p_successor_p</span><span class="p">,</span>
                                <span class="n">compose</span><span class="p">(</span>
                                    <span class="n">graph_p_successor_p</span><span class="p">,</span>
                                    <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_graph_successor</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span>
                            <span class="n">instances</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                            <span class="n">old_typing</span><span class="p">)</span>
                        <span class="c1"># already lifted to the successor</span>
                        <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                            <span class="n">graph_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">graph_id</span><span class="p">]</span>
                            <span class="n">suc_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">successor</span><span class="p">]</span>
                            <span class="n">graph_lhs_successor_lhs</span> <span class="o">=</span> <span class="n">get_unique_map_to_pullback</span><span class="p">(</span>
                                <span class="n">suc_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span>
                                <span class="n">instances</span><span class="p">[</span><span class="n">successor</span><span class="p">],</span>
                                <span class="n">l_g_ls</span><span class="p">[</span><span class="n">successor</span><span class="p">],</span>
                                <span class="n">compose</span><span class="p">(</span>
                                    <span class="n">instances</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                                    <span class="n">old_typing</span><span class="p">),</span>
                                <span class="n">l_g_ls</span><span class="p">[</span><span class="n">graph_id</span><span class="p">])</span>
                            <span class="n">graph_p_successor_p</span> <span class="o">=</span> <span class="n">get_unique_map_to_pullback</span><span class="p">(</span>
                                <span class="n">suc_rule</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span>
                                <span class="n">suc_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span>
                                <span class="n">p_g_ps</span><span class="p">[</span><span class="n">successor</span><span class="p">],</span>
                                <span class="n">compose</span><span class="p">(</span>
                                    <span class="n">graph_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span>
                                    <span class="n">graph_lhs_successor_lhs</span><span class="p">),</span>
                                <span class="n">p_g_ps</span><span class="p">[</span><span class="n">graph_id</span><span class="p">])</span>

                            <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                <span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">graph_lhs_successor_lhs</span><span class="p">,</span>
                                    <span class="n">graph_p_successor_p</span><span class="p">,</span>
                                    <span class="n">graph_p_successor_p</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">descendants</span><span class="p">:</span>
                            <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">compose</span><span class="p">(</span><span class="n">l_g_ls</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                                        <span class="n">l_l_ts</span><span class="p">[</span><span class="n">successor</span><span class="p">]),</span>
                                <span class="n">compose</span><span class="p">(</span><span class="n">p_g_ps</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                                        <span class="n">p_p_ts</span><span class="p">[</span><span class="n">successor</span><span class="p">]),</span>
                                <span class="n">compose</span><span class="p">(</span>
                                    <span class="n">compose</span><span class="p">(</span><span class="n">p_g_ps</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                                            <span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">),</span>
                                    <span class="n">r_r_ts</span><span class="p">[</span><span class="n">successor</span><span class="p">])</span>
                            <span class="p">)</span>
                        <span class="c1"># didn&#39;t touch the successor or projected to it</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>

            <span class="k">if</span> <span class="n">graph_id</span> <span class="ow">in</span> <span class="n">descendants</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                    <span class="n">old_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">predecessor</span> <span class="o">==</span> <span class="n">origin_id</span><span class="p">:</span>
                        <span class="n">predecessor_l_graph_l</span> <span class="o">=</span> <span class="n">l_l_ts</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
                        <span class="n">predecessor_p_graph_p</span> <span class="o">=</span> <span class="n">p_p_ts</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
                        <span class="n">predecessor_rhs_graph_rhs</span> <span class="o">=</span> <span class="n">r_r_ts</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
                        <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                            <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">predecessor_l_graph_l</span><span class="p">,</span>
                                <span class="n">predecessor_p_graph_p</span><span class="p">,</span>
                                <span class="n">predecessor_rhs_graph_rhs</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># already projected to the predecessor</span>
                        <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="n">descendants</span><span class="p">:</span>

                            <span class="n">l_pred_graph</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span>
                                <span class="n">instances</span><span class="p">[</span><span class="n">predecessor</span><span class="p">],</span>
                                <span class="n">old_typing</span><span class="p">)</span>
                            <span class="n">predecessor_l_graph_l</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">[</span>
                                    <span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">predecessor_l_graph_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                                    <span class="n">instances</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                                    <span class="n">l_pred_graph</span><span class="p">[</span><span class="n">k</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="n">predecessor_rhs_graph_rhs</span> <span class="o">=</span> <span class="n">get_unique_map_from_pushout</span><span class="p">(</span>
                                <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span>
                                <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">,</span>
                                <span class="n">r_r_ts</span><span class="p">[</span><span class="n">predecessor</span><span class="p">],</span>
                                <span class="n">compose</span><span class="p">(</span>
                                    <span class="n">predecessor_l_graph_l</span><span class="p">,</span>
                                    <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">graph_id</span><span class="p">]</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">),</span>
                                <span class="n">r_r_ts</span><span class="p">[</span><span class="n">graph_id</span><span class="p">])</span>

                            <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">predecessor_l_graph_l</span><span class="p">,</span>
                                    <span class="n">predecessor_l_graph_l</span><span class="p">,</span>
                                    <span class="n">predecessor_rhs_graph_rhs</span>
                            <span class="p">)</span>
                        <span class="c1"># didn&#39;t touch the predecessor or lifter to it</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span></div>

<div class="viewcode-block" id="Hierarchy.refine_rule_hierarchy"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.refine_rule_hierarchy">[docs]</a>    <span class="k">def</span> <span class="nf">refine_rule_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refine the input rule hierarchy to its reversible version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule_hierarchy : dict</span>
<span class="sd">            Rule hierarchy to refine</span>
<span class="sd">        instances : dict of dict</span>
<span class="sd">            Dictionary containing ids of the graphs in the hierarchy as keys</span>
<span class="sd">            and dictionaries represening instances of the corresponding rules</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_instances : dict of dict</span>
<span class="sd">            Dictionary containing ids of the graphs in the hierarchy as keys</span>
<span class="sd">            and dictionaries represening new instances of the corresponding</span>
<span class="sd">            refined rules</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_lhs_instances</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">new_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_rule_homomorphisms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Refine individual rules</span>
        <span class="k">for</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># refine rule</span>
            <span class="n">new_lhs_instance</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">),</span> <span class="n">instances</span><span class="p">[</span><span class="n">graph</span><span class="p">])</span>
            <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lhs_instance</span>

        <span class="c1"># Update rule homomorphisms</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="p">(</span><span class="n">lhs_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">rhs_h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">source_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">source</span><span class="p">]</span>
            <span class="n">target_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lhs_h</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">source_node</span> <span class="o">=</span> <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="n">node</span><span class="p">]</span>
                    <span class="n">target_node</span> <span class="o">=</span> <span class="n">typing</span><span class="p">[</span><span class="n">source_node</span><span class="p">]</span>
                    <span class="n">target_lhs_node</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">target_node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">lhs_h</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_lhs_node</span>

                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">source_p_node</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                            <span class="n">source_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span> <span class="n">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">target_p_node</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                            <span class="n">target_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span> <span class="n">target_lhs_node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">p_h</span><span class="p">[</span><span class="n">source_p_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_p_node</span>

                        <span class="n">source_rhs_node</span> <span class="o">=</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">[</span><span class="n">source_p_node</span><span class="p">]</span>
                        <span class="n">target_rhs_node</span> <span class="o">=</span> <span class="n">target_rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">[</span><span class="n">target_p_node</span><span class="p">]</span>
                        <span class="n">rhs_h</span><span class="p">[</span><span class="n">source_rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_rhs_node</span>
            <span class="c1"># Add necessary node attrs</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="n">t_node</span> <span class="o">=</span> <span class="n">lhs_h</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="n">target_rule</span><span class="o">.</span><span class="n">_add_node_attrs_lhs</span><span class="p">(</span><span class="n">t_node</span><span class="p">,</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="c1"># Add necessary node edges</span>
            <span class="k">for</span> <span class="n">s_lhs_s</span><span class="p">,</span> <span class="n">s_lhs_t</span> <span class="ow">in</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">t_lhs_s</span> <span class="o">=</span> <span class="n">lhs_h</span><span class="p">[</span><span class="n">s_lhs_s</span><span class="p">]</span>
                <span class="n">t_lhs_t</span> <span class="o">=</span> <span class="n">lhs_h</span><span class="p">[</span><span class="n">s_lhs_t</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">target_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">exists_edge</span><span class="p">(</span><span class="n">t_lhs_s</span><span class="p">,</span> <span class="n">t_lhs_t</span><span class="p">):</span>
                    <span class="n">target_rule</span><span class="o">.</span><span class="n">_add_edge_lhs</span><span class="p">(</span>
                        <span class="n">t_lhs_s</span><span class="p">,</span>
                        <span class="n">t_lhs_t</span><span class="p">,</span>
                        <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">s_lhs_s</span><span class="p">,</span> <span class="n">s_lhs_t</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_rule</span><span class="o">.</span><span class="n">_add_edge_attrs_lhs</span><span class="p">(</span>
                        <span class="n">t_lhs_s</span><span class="p">,</span>
                        <span class="n">t_lhs_t</span><span class="p">,</span>
                        <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">s_lhs_s</span><span class="p">,</span> <span class="n">s_lhs_t</span><span class="p">))</span>

        <span class="c1"># If merge is performed, add all the instances of the merged nodes</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="p">(</span><span class="n">lhs_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">rhs_h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">source_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">source</span><span class="p">]</span>
            <span class="n">target_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>
            <span class="n">typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_rule</span><span class="o">.</span><span class="n">merged_nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rhs_node</span><span class="p">,</span> <span class="n">p_nodes</span> <span class="ow">in</span> <span class="n">target_rule</span><span class="o">.</span><span class="n">merged_nodes</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># rhs_node_instances = keys_by_value(typing, rhs_node)</span>
                    <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">:</span>
                        <span class="n">lhs_node_instance</span> <span class="o">=</span> <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                            <span class="n">target_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">p_node</span><span class="p">]]</span>
                        <span class="n">source_nodes</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">n</span>
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">typing</span><span class="p">,</span> <span class="n">lhs_node_instance</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="n">source_nodes_to_add</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">s</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_nodes</span>
                            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                        <span class="p">]</span>

                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">source_nodes_to_add</span><span class="p">:</span>
                            <span class="n">lhs_s_node</span> <span class="o">=</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">generate_new_node_id</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                            <span class="n">p_s_node</span><span class="p">,</span> <span class="n">rhs_s_node</span> <span class="o">=</span> <span class="n">source_rule</span><span class="o">.</span><span class="n">_add_node_lhs</span><span class="p">(</span>
                                <span class="n">lhs_s_node</span><span class="p">)</span>
                            <span class="c1"># Add the instances of the new lhs node</span>
                            <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="n">lhs_s_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                            <span class="c1"># Add maps to the target for the new lhs node</span>
                            <span class="n">lhs_h</span><span class="p">[</span><span class="n">lhs_s_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                            <span class="n">p_h</span><span class="p">[</span><span class="n">p_s_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_node</span>
                            <span class="n">rhs_h</span><span class="p">[</span><span class="n">rhs_s_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_node</span>

        <span class="c1"># Add identity rules where needed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if the are no rules in the rule hierarchy,</span>
            <span class="c1"># create the identity rule for every graph</span>
            <span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
                <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">identity_rule</span><span class="p">()</span>
                <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">():</span>
                <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add identity rules where needed</span>
            <span class="c1"># to preserve the info on p/rhs_typing</span>
            <span class="c1"># add ancestors that are not included in rule hierarchy</span>
            <span class="k">for</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">ancestor</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ancestors</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ancestor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span> <span class="ow">and</span>\
                       <span class="n">ancestor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                        <span class="c1"># Find a typing of ancestor by the graph</span>
                        <span class="n">l_pred</span><span class="p">,</span> <span class="n">l_pred_pred</span><span class="p">,</span> <span class="n">l_pred_l_graph</span> <span class="o">=</span> <span class="n">pullback</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">ancestor</span><span class="p">),</span> <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">),</span> <span class="n">typing</span><span class="p">,</span>
                            <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">graph</span><span class="p">])</span>
                        <span class="n">new_rules</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">l_pred</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">l_pred</span><span class="p">)</span>
                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">ancestor</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_pred_pred</span>
                        <span class="n">r_pred_r_graph</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">v</span><span class="p">:</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l_pred_l_graph</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">ancestor</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">successor</span> <span class="o">==</span> <span class="n">graph</span><span class="p">:</span>
                                    <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                        <span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">graph</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">l_pred_l_graph</span><span class="p">,</span> <span class="n">l_pred_l_graph</span><span class="p">,</span>
                                            <span class="n">r_pred_r_graph</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
                                    <span class="n">lhs_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">rhs_h</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                                        <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                            <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                                        <span class="n">new_lhs_h</span><span class="p">,</span> <span class="n">new_p_h</span><span class="p">,</span> <span class="n">new_rhs_h</span> <span class="o">=</span>\
                                            <span class="n">rule_hierarchy</span><span class="p">[</span>
                                                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                                    <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                                        <span class="n">lhs_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">lhs_h</span><span class="p">,</span> <span class="n">new_lhs_h</span><span class="p">)</span>
                                        <span class="n">p_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">p_h</span><span class="p">,</span> <span class="n">new_p_h</span><span class="p">)</span>
                                        <span class="n">rhs_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">rhs_h</span><span class="p">,</span> <span class="n">new_rhs_h</span><span class="p">)</span>

                                    <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                        <span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">l_pred_l_graph</span><span class="p">,</span> <span class="n">lhs_h</span><span class="p">),</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">l_pred_l_graph</span><span class="p">,</span> <span class="n">p_h</span><span class="p">),</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">r_pred_r_graph</span><span class="p">,</span> <span class="n">rhs_h</span><span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                                <span class="n">lhs_h</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">keys_by_value</span><span class="p">(</span>
                                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">successor</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span>
                                            <span class="n">ancestor</span><span class="p">,</span> <span class="n">successor</span><span class="p">)[</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_lhs_instances</span><span class="p">[</span>
                                        <span class="n">ancestor</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span>
                                <span class="p">)</span>
                        <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">ancestor</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                               <span class="n">predecessor</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                                <span class="n">lhs_h</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">keys_by_value</span><span class="p">(</span>
                                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">ancestor</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span>
                                            <span class="n">predecessor</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">)[</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_lhs_instances</span><span class="p">[</span>
                                        <span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span>
                                <span class="p">)</span>

                <span class="k">for</span> <span class="n">descendant</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">descendant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span> <span class="ow">and</span>\
                       <span class="n">descendant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                        <span class="n">l_suc</span><span class="p">,</span> <span class="n">l_graph_l_suc</span><span class="p">,</span> <span class="n">l_suc_suc</span> <span class="o">=</span> <span class="n">image_factorization</span><span class="p">(</span>
                            <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">descendant</span><span class="p">),</span>
                            <span class="n">compose</span><span class="p">(</span>
                                <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">graph</span><span class="p">],</span>
                                <span class="n">typing</span><span class="p">))</span>
                        <span class="n">new_rules</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">l_suc</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">l_suc</span><span class="p">)</span>
                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_suc_suc</span>
                        <span class="n">p_graph_p_suc</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="n">l_graph_l_suc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">descendant</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">predecessor</span> <span class="o">==</span> <span class="n">graph</span><span class="p">:</span>
                                    <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                        <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">descendant</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">l_graph_l_suc</span><span class="p">,</span>
                                            <span class="n">p_graph_p_suc</span><span class="p">,</span>
                                            <span class="n">p_graph_p_suc</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span>
                                        <span class="n">predecessor</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
                                    <span class="n">lhs_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">rhs_h</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                                        <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                            <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                                        <span class="n">new_lhs_h</span><span class="p">,</span> <span class="n">new_p_h</span><span class="p">,</span> <span class="n">new_rhs_h</span> <span class="o">=</span>\
                                            <span class="n">rule_hierarchy</span><span class="p">[</span>
                                                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][</span>
                                                    <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                                        <span class="n">lhs_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">lhs_h</span><span class="p">,</span> <span class="n">new_lhs_h</span><span class="p">)</span>
                                        <span class="n">p_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">p_h</span><span class="p">,</span> <span class="n">new_p_h</span><span class="p">)</span>
                                        <span class="n">rhs_h</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">rhs_h</span><span class="p">,</span> <span class="n">new_rhs_h</span><span class="p">)</span>
                                    <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                        <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">descendant</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">lhs_h</span><span class="p">,</span> <span class="n">l_graph_l_suc</span><span class="p">),</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">p_h</span><span class="p">,</span> <span class="n">p_graph_p_suc</span><span class="p">),</span>
                                            <span class="n">compose</span><span class="p">(</span><span class="n">rhs_h</span><span class="p">,</span> <span class="n">p_graph_p_suc</span><span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                                <span class="n">lhs_h</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">keys_by_value</span><span class="p">(</span>
                                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">descendant</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span>
                                            <span class="n">predecessor</span><span class="p">,</span> <span class="n">descendant</span><span class="p">)[</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_lhs_instances</span><span class="p">[</span>
                                        <span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">descendant</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span>
                                <span class="p">)</span>

                        <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">descendant</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                               <span class="n">successor</span> <span class="ow">in</span> <span class="n">new_rules</span><span class="p">:</span>
                                <span class="n">lhs_h</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="n">k</span><span class="p">:</span> <span class="n">keys_by_value</span><span class="p">(</span>
                                        <span class="n">new_lhs_instances</span><span class="p">[</span><span class="n">successor</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span>
                                            <span class="n">descendant</span><span class="p">,</span> <span class="n">successor</span><span class="p">)[</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_lhs_instances</span><span class="p">[</span>
                                        <span class="n">descendant</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">new_rule_homomorphisms</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">descendant</span><span class="p">,</span> <span class="n">successor</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span><span class="p">,</span> <span class="n">lhs_h</span>
                                <span class="p">)</span>

        <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_rules</span><span class="p">)</span>
        <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">new_rule_homomorphisms</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_lhs_instances</span></div>

<div class="viewcode-block" id="Hierarchy.unique_graph_id"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.unique_graph_id">[docs]</a>    <span class="k">def</span> <span class="nf">unique_graph_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a new graph id starting with a prefix.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">prefix</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hierarchy.duplicate_subgraph"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.duplicate_subgraph">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate_subgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_dict</span><span class="p">,</span> <span class="n">attach_graphs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Duplicate a subgraph induced by the set of nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_dict : dict</span>
<span class="sd">            Dictionary contaning names of graphs to duplicate as keys</span>
<span class="sd">            and their new IDs in the hierarchy as values</span>
<span class="sd">        attach_graphs : list, optional</span>
<span class="sd">            List of not duplicated graph IDs that should be reattached to</span>
<span class="sd">            the duplicated graphs, if empty, duplicated subgraph</span>
<span class="sd">            is disconnected from the rest of the hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_graphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">old_graphs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot duplicate the graph &#39;</span><span class="si">{}</span><span class="s2">&#39; as &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">original</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;the graph &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;already exists in the hierarchy!&quot;</span><span class="p">)</span>

        <span class="c1"># copy graphs</span>
        <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_graph</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">attach_graphs</span><span class="p">)</span>

        <span class="c1"># copy typing between duplicated graphs</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">]</span>
            <span class="n">sucs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">graph_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sucs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
                    <span class="n">graph_dict</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">graph_dict</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
                    <span class="n">graph_dict</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">graph_dict</span><span class="p">[</span><span class="n">g</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span></div>

<div class="viewcode-block" id="Hierarchy.relation_to_span"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relation_to_span">[docs]</a>    <span class="k">def</span> <span class="nf">relation_to_span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert relation to a span.</span>

<span class="sd">        This method computes the span of the form</span>
<span class="sd">        `left` &lt;- `common` -&gt; `right` from a binary</span>
<span class="sd">        symmetric relation between two graphs in</span>
<span class="sd">        the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `left` graph</span>
<span class="sd">        right</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `right` graph</span>
<span class="sd">        edges : bool, optional</span>
<span class="sd">            If True, maximal set of edges is added to the common</span>
<span class="sd">            part graph</span>
<span class="sd">        attrs : bool, optional</span>
<span class="sd">            If True, maximal dict of attrs is added to the nodes of</span>
<span class="sd">            the common part graph</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        common : nx.(Di)Graph</span>
<span class="sd">            Graph representing the common part graph induced</span>
<span class="sd">            by the relation</span>
<span class="sd">        left_h : dict</span>
<span class="sd">            Homomorphism from the common part graph to the left</span>
<span class="sd">            graph of the relation</span>
<span class="sd">        right_h : dict</span>
<span class="sd">            Homomorphism from the common part graph to the right</span>
<span class="sd">            graph of the relation</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If nodes corresponding to either `left` or `right` ids</span>
<span class="sd">            do not exist in the hierarchy, or there is no relation</span>
<span class="sd">            between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">{}</span><span class="s2">&#39; is not defined in the hierarchy!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">right</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Node &#39;</span><span class="si">{}</span><span class="s2">&#39; is not defined in the hierarchy!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">()</span> <span class="ow">and</span>\
           <span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Relation between graphs &#39;</span><span class="si">{}</span><span class="s2">&#39; and &#39;</span><span class="si">{}</span><span class="s2">&#39; is not defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">common</span><span class="p">,</span> <span class="n">left_h</span><span class="p">,</span> <span class="n">right_h</span> <span class="o">=</span> <span class="n">relation_to_span</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">left</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">right</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span>
            <span class="n">edges</span><span class="p">,</span>
            <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">common</span><span class="p">,</span> <span class="n">left_h</span><span class="p">,</span> <span class="n">right_h</span></div>

<div class="viewcode-block" id="Hierarchy.find_matching"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.find_matching">[docs]</a>    <span class="k">def</span> <span class="nf">find_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span>
                      <span class="n">pattern_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find an instance of a pattern in a specified graph.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a graph in the hierarchy to search for matches</span>
<span class="sd">        pattern : Graph object</span>
<span class="sd">            A pattern to match</span>
<span class="sd">        pattern_typing : dict</span>
<span class="sd">            A dictionary that specifies a typing of a pattern,</span>
<span class="sd">            keys of the dictionary -- graph id that types a pattern, this graph</span>
<span class="sd">            should be among parents of the `graph_id` graph;</span>
<span class="sd">            values are mappings of nodes from pattern to the typing graph;</span>
<span class="sd">        nodes : iterable</span>
<span class="sd">            Subset of nodes where matching should be performed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        instances : list of dict</span>
<span class="sd">            List of matched instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pattern_typing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pattern_typing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Check that &#39;typing_graph&#39; and &#39;pattern_typing&#39; are correctly</span>
        <span class="c1"># specified</span>
        <span class="n">descendants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern_typing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">typing_graph</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pattern_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">typing_graph</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">descendants</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                        <span class="s2">&quot;Pattern typing graph &#39;</span><span class="si">{}</span><span class="s2">&#39; is not in &quot;</span>
                        <span class="s2">&quot;the (transitive) typing graphs of &#39;</span><span class="si">{}</span><span class="s2">&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">typing_graph</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Check pattern typing is a valid homomorphism</span>
            <span class="k">for</span> <span class="n">typing_graph</span><span class="p">,</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">pattern_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">check_homomorphism</span><span class="p">(</span>
                        <span class="n">pattern</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">typing_graph</span><span class="p">),</span>
                        <span class="n">mapping</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidHomomorphism</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReGraphError</span><span class="p">(</span>
                        <span class="s2">&quot;Specified pattern is not valid in the &quot;</span>
                        <span class="s2">&quot;hierarchy (it produces the following error: &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">graph_typing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">typing_graph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">typing_graph</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">typing_graph</span> <span class="ow">in</span> <span class="n">pattern_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">find_matching</span><span class="p">(</span>
            <span class="n">pattern</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">graph_typing</span><span class="p">,</span> <span class="n">pattern_typing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instances</span></div>

<div class="viewcode-block" id="Hierarchy.rewrite"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.rewrite">[docs]</a>    <span class="k">def</span> <span class="nf">rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
                <span class="n">p_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rewrite and propagate the changes backward &amp; forward.</span>

<span class="sd">        Rewriting in the hierarchy cosists of an application of the</span>
<span class="sd">        SqPO-rewriting rule (given by the &#39;rule&#39; parameter) to a</span>
<span class="sd">        graph in the hierarchy. Such rewriting often triggers a set of</span>
<span class="sd">        changes that are applied to other graphs and homomorphisms in the</span>
<span class="sd">        hierarchy, which are necessary to ensure that the hierarchy stays</span>
<span class="sd">        consistent. If the rule is restrictive (deletes nodes/edges/attrs</span>
<span class="sd">        or clones nodes), in general, the respective changes to all the graphs</span>
<span class="sd">        (transitively) typed by the graph subject to rewriting are made.</span>
<span class="sd">        On the other hand, if the rule is relaxing (adds nodes/edges/attrs</span>
<span class="sd">        or merges nodes), in general, the respective changes to all the graphs</span>
<span class="sd">        that (tansitively) type the graph subject to rewriting are made.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id</span>
<span class="sd">            Id of the graph in the hierarchy to rewrite</span>
<span class="sd">        rule : regraph.rule.Rule</span>
<span class="sd">            Rule object to apply</span>
<span class="sd">        instance : dict, optional</span>
<span class="sd">            Dictionary containing an instance of the lhs of the rule in</span>
<span class="sd">            the graph subject to rewriting, by default, tries to construct</span>
<span class="sd">            identity morphism of the nodes of the pattern</span>
<span class="sd">        p_typing : dict, optional</span>
<span class="sd">            Dictionary containing typing of graphs in the hierarchy by the</span>
<span class="sd">            interface of the rule, keys are ids of hierarchy graphs,</span>
<span class="sd">            values are dictionaries containing the mapping of nodes from</span>
<span class="sd">            the hierarchy graphs to the inteface nodes (note that a node</span>
<span class="sd">            from a graph can be typed by a set of nodes in</span>
<span class="sd">            the interface of the rule, e.g. if we want to perform</span>
<span class="sd">            cloning of some types, etc).</span>
<span class="sd">        rhs_typing : dict, optional</span>
<span class="sd">            Dictionary containing typing of the rhs by graphs of the hierarchy,</span>
<span class="sd">            keys are ids of hierarchy graphs, values are dictionaries</span>
<span class="sd">            containing the mapping of nodes from the rhs to the nodes of</span>
<span class="sd">            the typing graph given by the respective key of the value</span>
<span class="sd">            (note that a node from the rhs can be typed by a set of nodes of</span>
<span class="sd">            some graph, e.g. if we want to perform merging of some types, etc).</span>
<span class="sd">        strict : bool, optional</span>
<span class="sd">            Rewriting is strict when propagation down is not allowed</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If the graph is not in the database</span>
<span class="sd">        RewritingError</span>
<span class="sd">            If the provided p and rhs typing are inconsistent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Type check the input rule, its instance and typing</span>
        <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rule_instance_typing</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>

        <span class="c1"># Perform a restrictive rewrite</span>
        <span class="n">p_g_m</span><span class="p">,</span> <span class="n">g_m_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_rewrite</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>

        <span class="c1"># Propagate backward and fix broken homomorphisms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_backward</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_g_m</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">)</span>

        <span class="c1"># Propagate forward and fix broken homomorphisms</span>
        <span class="n">rhs_g_prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_rewrite_and_propagate_forward</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_g_m</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rhs_g_prime</span></div>

<div class="viewcode-block" id="Hierarchy.new_apply_rule_hierarchy"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.new_apply_rule_hierarchy">[docs]</a>    <span class="k">def</span> <span class="nf">new_apply_rule_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply rule hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule_hierarchy : dict</span>
<span class="sd">            Dictionary containing the input rule hierarchy</span>
<span class="sd">        instances : dict</span>
<span class="sd">            Dictionary containing an instance for every rule in the hierarchy</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rhs_instances : dict</span>
<span class="sd">            Dictionary containing the RHS instances for every</span>
<span class="sd">            graph in the hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the rule hierarchy is applicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_applicability</span><span class="p">(</span><span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hierarchy.apply_rule_hierarchy"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.apply_rule_hierarchy">[docs]</a>    <span class="k">def</span> <span class="nf">apply_rule_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply rule hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule_hierarchy : dict</span>
<span class="sd">            Dictionary containing the input rule hierarchy</span>
<span class="sd">        instances : dict</span>
<span class="sd">            Dictionary containing an instance for every rule in the hierarchy</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rhs_instances : dict</span>
<span class="sd">            Dictionary containing the RHS instances for every</span>
<span class="sd">            graph in the hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the rule hierarchy is applicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_applicability</span><span class="p">(</span><span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">)</span>

        <span class="n">updated_graphs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Apply rules to the hierarchy</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">instances</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>
            <span class="n">graph_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">is_restrictive</span><span class="p">():</span>
                <span class="n">p_g_m</span><span class="p">,</span> <span class="n">g_m_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_rewrite</span><span class="p">(</span>
                    <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_g_m</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">g_m_g</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="n">updated_graphs</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;p_g_m&quot;</span><span class="p">:</span> <span class="n">p_g_m</span><span class="p">,</span>
                <span class="s2">&quot;g_m_g&quot;</span><span class="p">:</span> <span class="n">g_m_g</span>
            <span class="p">}</span>

        <span class="c1"># Restore homomorphisms after restrictive rewrite</span>
        <span class="c1"># and backward propagation</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">source_m_target_m</span> <span class="o">=</span> <span class="n">get_unique_map_to_pullback_complement</span><span class="p">(</span>
                <span class="n">updated_graphs</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;p_g_m&quot;</span><span class="p">],</span>
                <span class="n">updated_graphs</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;g_m_g&quot;</span><span class="p">],</span>
                <span class="n">p_h</span><span class="p">,</span>
                <span class="n">updated_graphs</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s2">&quot;p_g_m&quot;</span><span class="p">],</span>
                <span class="n">compose</span><span class="p">(</span>
                    <span class="n">updated_graphs</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s2">&quot;g_m_g&quot;</span><span class="p">],</span>
                    <span class="n">old_typing</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">source_m_target_m</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">is_relaxing</span><span class="p">():</span>
                <span class="n">r_g_prime</span><span class="p">,</span> <span class="n">g_m_g_prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_rewrite</span><span class="p">(</span>
                    <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">updated_graphs</span><span class="p">[</span><span class="n">graph_id</span><span class="p">][</span><span class="s2">&quot;p_g_m&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g_m_g_prime</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">r_g_prime</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">v</span><span class="p">:</span> <span class="n">updated_graphs</span><span class="p">[</span><span class="n">graph_id</span><span class="p">][</span><span class="s2">&quot;p_g_m&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>

            <span class="n">updated_graphs</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;g_m_g_prime&quot;</span><span class="p">:</span> <span class="n">g_m_g_prime</span><span class="p">,</span>
                <span class="s2">&quot;r_g_prime&quot;</span><span class="p">:</span> <span class="n">r_g_prime</span>
            <span class="p">}</span>

        <span class="c1"># Restore homomorphisms after expansive rewrite</span>
        <span class="c1"># and forward propagation</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rhs_h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                <span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">source_p_target_p</span> <span class="o">=</span> <span class="n">get_unique_map_from_pushout</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">(),</span>
                <span class="n">updated_graphs</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s2">&quot;g_m_g_prime&quot;</span><span class="p">],</span>
                <span class="n">updated_graphs</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s2">&quot;r_g_prime&quot;</span><span class="p">],</span>
                <span class="n">compose</span><span class="p">(</span>
                    <span class="n">old_typing</span><span class="p">,</span>
                    <span class="n">updated_graphs</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;g_m_g_prime&quot;</span><span class="p">]),</span>
                <span class="n">compose</span><span class="p">(</span>
                    <span class="n">rhs_h</span><span class="p">,</span>
                    <span class="n">updated_graphs</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;r_g_prime&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">source_p_target_p</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;r_g_prime&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">updated_graphs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

    <span class="k">def</span> <span class="nf">_check_rule_instance_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
                                    <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">,</span> <span class="n">strict</span><span class="p">):</span>
        <span class="c1"># Normalize the instance, p_typing and rhs_typing</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">p_typing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_typing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_typing</span> <span class="o">=</span> <span class="n">normalize_typing_relation</span><span class="p">(</span><span class="n">p_typing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rhs_typing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rhs_typing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs_typing</span> <span class="o">=</span> <span class="n">normalize_typing_relation</span><span class="p">(</span><span class="n">rhs_typing</span><span class="p">)</span>

        <span class="c1"># Check that the instance is valid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_homomorphism</span><span class="p">(</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">origin_id</span><span class="p">),</span>
                <span class="n">instance</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidHomomorphism</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Homomorphism from the pattern to the instance subgraph &quot;</span>
                <span class="s2">&quot;is not valid, got: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="c1"># Check that the instance is a mono</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_monic</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Homomorphism from the pattern to the instance subgraph &quot;</span>
                <span class="s2">&quot;is not injective&quot;</span><span class="p">)</span>

        <span class="c1"># Check p_typing does not retype nodes</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph_to_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">graph_to_origin</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">instance</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">vv</span><span class="p">]]:</span>
                        <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                            <span class="s2">&quot;The specified typing of &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;by the interface is not valid: &quot;</span>
                            <span class="s2">&quot;node &#39;</span><span class="si">{}</span><span class="s2">&#39; is typed by &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">k</span><span class="p">,</span> <span class="n">graph_to_origin</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span>
                            <span class="s2">&quot;in the origin of rewriting, while the interface &quot;</span>
                            <span class="s2">&quot;node &#39;</span><span class="si">{}</span><span class="s2">&#39; is typed by &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">vv</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">vv</span><span class="p">]]))</span>

        <span class="c1"># Check composability of p_typing</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">predecessors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="p">:</span>
                    <span class="c1"># check that the typing of &#39;graph_id&#39; is canonical</span>
                    <span class="n">canonical</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">graph_n</span><span class="p">,</span> <span class="n">p_nodes</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lhs_n</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">p_nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">canonical_clones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys_by_value</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">,</span> <span class="n">lhs_n</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">p_nodes</span> <span class="o">==</span> <span class="n">canonical_clones</span><span class="p">:</span>
                                <span class="n">canonical</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">canonical</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                            <span class="s2">&quot;Typing of &#39;</span><span class="si">{}</span><span class="s2">&#39; by the interface &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;is not composable with the &quot;</span>
                            <span class="s2">&quot;typig of &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;propagation to &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;is canonical and produces instances for </span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">canonical_clones</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;while propagation to &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;produces only for &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">p_nodes</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="n">successors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">suc</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">:</span>
                <span class="n">suc_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">suc</span><span class="p">)</span>
                <span class="c1"># check p_typing for suc is composable</span>
                <span class="k">for</span> <span class="n">graph_n</span><span class="p">,</span> <span class="n">p_nodes</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">suc_n</span> <span class="o">=</span> <span class="n">suc_typing</span><span class="p">[</span><span class="n">graph_n</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">suc</span> <span class="ow">in</span> <span class="n">p_typing</span> <span class="ow">and</span> <span class="n">suc_n</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="p">[</span><span class="n">suc</span><span class="p">]:</span>
                        <span class="n">suc_p_nodes</span> <span class="o">=</span> <span class="n">p_typing</span><span class="p">[</span><span class="n">suc</span><span class="p">][</span><span class="n">suc_n</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">p_nodes</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">suc_p_nodes</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                                <span class="s2">&quot;Typing of &#39;</span><span class="si">{}</span><span class="s2">&#39; by the interface &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;is not composable with the &quot;</span>
                                <span class="s2">&quot;typig of &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suc</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;propagation to the node &quot;</span>
                                <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; of &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_n</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;will produce instances for </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">p_nodes</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;while propagation to &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">suc_n</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot;typing it produces only </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">suc_p_nodes</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ok, because suc_n is canonically cloned</span>
                        <span class="k">pass</span>

        <span class="c1"># Autocomplete and check rhs_typing</span>
        <span class="n">new_rhs_typing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">descendant</span><span class="p">,</span> <span class="n">descendant_typing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span>
                    <span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">descendant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="p">:</span>
                    <span class="c1"># autocomplete descendant typing in the new rhs typing</span>
                    <span class="n">new_rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">rhs_n</span><span class="p">:</span> <span class="p">{</span>
                            <span class="n">descendant_typing</span><span class="p">[</span><span class="n">graph_n</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">graph_n</span> <span class="ow">in</span> <span class="n">graph_ns</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">rhs_n</span><span class="p">,</span> <span class="n">graph_ns</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># autocomplete descendant typing with missing rhs nodes</span>
                    <span class="c1"># and check that already specified types for descendant</span>
                    <span class="c1"># are composable with the typing for &#39;graph_id&#39;</span>
                    <span class="n">descendant_rhs_typing</span> <span class="o">=</span> <span class="n">rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">rhs_n</span><span class="p">,</span> <span class="n">graph_ns</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">rhs_n</span> <span class="ow">in</span> <span class="n">descendant_rhs_typing</span><span class="p">:</span>
                            <span class="n">descendant_ns</span> <span class="o">=</span> <span class="n">descendant_rhs_typing</span><span class="p">[</span><span class="n">rhs_n</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">graph_n</span> <span class="ow">in</span> <span class="n">graph_ns</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">descendant_typing</span><span class="p">[</span><span class="n">graph_n</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">descendant_ns</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                                        <span class="s2">&quot;Typing of the RHS &quot;</span>
                                        <span class="s2">&quot;by &#39;</span><span class="si">{}</span><span class="s2">&#39; is not composable &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s2">&quot;with its typing by &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">descendant</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s2">&quot;node &#39;</span><span class="si">{}</span><span class="s2">&#39; is typed by &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">rhs_n</span><span class="p">,</span> <span class="n">graph_n</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s2">&quot;in &#39;</span><span class="si">{}</span><span class="s2">&#39; that is not typed by &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s2">&quot;either of </span><span class="si">{}</span><span class="s2"> from &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">descendant_ns</span><span class="p">,</span> <span class="n">descendant</span><span class="p">)</span>
                                    <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">]</span>
                            <span class="n">new_rhs_typing</span><span class="p">[</span><span class="n">descendant</span><span class="p">][</span><span class="n">rhs_n</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">descendant_typing</span><span class="p">[</span><span class="n">graph_n</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">graph_n</span> <span class="ow">in</span> <span class="n">graph_ns</span>
                            <span class="p">}</span>

        <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">new_rhs_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rhs_typing</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># Check rhs_typing does not retype nodes</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">origin_to_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">p_nodes</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">graph_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
                        <span class="n">origin_to_graph</span><span class="p">[</span><span class="n">instance</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">p_node</span><span class="p">]]]</span>
                        <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">graph_nodes</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                            <span class="s2">&quot;The specified typing of the RHS &quot;</span>
                            <span class="s2">&quot;by the graph &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;is not valid: &quot;</span>
                            <span class="s2">&quot;node &#39;</span><span class="si">{}</span><span class="s2">&#39; is a typed by </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">k</span><span class="p">,</span> <span class="n">graph_nodes</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;in the origin of rewriting, while it is &quot;</span>
                            <span class="s2">&quot;typed by </span><span class="si">{}</span><span class="s2"> in the typing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="c1"># If rewriting is strict, check p_typing types all clones,</span>
        <span class="c1"># there are no instances of removed elements and</span>
        <span class="c1"># and rhs typing types all new nodes and no different</span>
        <span class="c1"># types are merged</span>
        <span class="k">if</span> <span class="n">strict</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">test_strictness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span> <span class="n">rhs_typing</span>

    <span class="k">def</span> <span class="nf">_restrictive_rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a restrictive rewrite of the specified graph.</span>

<span class="sd">        This method rewrites the graph and updates its typing by</span>
<span class="sd">        the immediate successors. Note that as the result of this</span>
<span class="sd">        update, some homomorphisms (from ancestors) are broken!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the restrictive part of the rule</span>
        <span class="n">restrictive_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">p_lhs</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="n">p_g_m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span>
            <span class="n">restrictive_rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
        <span class="n">g_m_g</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="n">restrictive_rule</span><span class="o">.</span><span class="n">p_lhs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p_g_m</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">g_m_g</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_g_m</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_homs</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_rels</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p_g_m</span><span class="p">,</span> <span class="n">g_m_g</span>

    <span class="k">def</span> <span class="nf">_expansive_rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform an expansive rewrite of the specified graph.</span>

<span class="sd">        This method rewrites the graph and updates its typing by</span>
<span class="sd">        the immediate predecessors. Note that as the result of this</span>
<span class="sd">        update, some homomorphisms (to descendants) are broken!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the expansive part of the rule</span>
        <span class="n">expansive_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">p_rhs</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

        <span class="n">pred_typings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">p</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">adj_relations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacent_relations</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">r_g_prime</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span>
            <span class="n">expansive_rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>

        <span class="n">g_m_g_prime</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v</span><span class="p">:</span> <span class="n">r_g_prime</span><span class="p">[</span><span class="n">expansive_rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">g_m_g_prime</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_update_incident_homs</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g_prime</span><span class="p">,</span> <span class="n">pred_typings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_update_incident_rels</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g_prime</span><span class="p">,</span> <span class="n">adj_relations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_g_prime</span><span class="p">,</span> <span class="n">g_m_g_prime</span>

    <span class="k">def</span> <span class="nf">_compose_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">,</span> <span class="n">graph_m_origin_m</span><span class="p">,</span>
                          <span class="n">pred_m_origin_m</span><span class="p">,</span> <span class="n">pred_typing</span><span class="p">):</span>
        <span class="n">graph_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">get_unique_map_to_pullback</span><span class="p">(</span>
            <span class="n">graph_nodes</span><span class="p">,</span>
            <span class="n">g_m_g</span><span class="p">,</span>
            <span class="n">graph_m_origin_m</span><span class="p">,</span>
            <span class="n">pred_typing</span><span class="p">,</span>
            <span class="n">pred_m_origin_m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                            <span class="n">origin_m_origin</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Peform backward propagation of the original rewriting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g_m_gs</span> <span class="o">=</span> <span class="p">{</span><span class="n">origin_id</span><span class="p">:</span> <span class="n">origin_m_origin</span><span class="p">}</span>
        <span class="n">g_m_origin_ms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">graph_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">origin_id</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">graph_p_typing</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">graph_id</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">graph_p_typing</span> <span class="o">=</span> <span class="n">p_typing</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span>

            <span class="n">origin_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">)</span>

            <span class="n">g_m_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identity_map</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

            <span class="n">g_m_origin_m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">origin_typing</span><span class="p">)</span>
            <span class="c1"># Propagate node clones</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">cloned_nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_clone</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                    <span class="n">origin_m_origin</span><span class="p">,</span> <span class="n">graph_p_typing</span><span class="p">,</span>
                    <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">)</span>

            <span class="c1"># Propagate node deletes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">removed_nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_node_removal</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
                    <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">)</span>

            <span class="c1"># Propagate node attrs deletes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">removed_node_attrs</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_node_attrs_removal</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">p_origin_m</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">)</span>

            <span class="c1"># Propagate edge deletes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">removed_edges</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_edge_removal</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">)</span>

            <span class="c1"># Propagate edge attrs deletes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">removed_edge_attrs</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_edge_attrs_removal</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                    <span class="n">g_m_origin_m</span><span class="p">)</span>

            <span class="n">g_m_gs</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_m_g</span>
            <span class="n">g_m_origin_ms</span><span class="p">[</span><span class="n">graph_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_m_origin_m</span>

        <span class="c1"># Reconnect broken homomorphisms by composability</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g</span> <span class="ow">in</span> <span class="n">g_m_gs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                <span class="n">pred_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">graph_id</span> <span class="o">!=</span> <span class="n">origin_id</span><span class="p">:</span>
                    <span class="n">pred_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_backward</span><span class="p">(</span>
                        <span class="n">pred</span><span class="p">,</span>
                        <span class="n">graph_id</span><span class="p">,</span>
                        <span class="n">g_m_g</span><span class="p">,</span>
                        <span class="n">g_m_origin_ms</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                        <span class="n">g_m_origin_ms</span><span class="p">[</span><span class="n">pred</span><span class="p">],</span>
                        <span class="n">pred_typing</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pred_graph</span> <span class="o">=</span> <span class="n">g_m_origin_ms</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">pred_graph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expansive_rewrite_and_propagate_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                                 <span class="n">instance</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                                                 <span class="n">rhs_typing</span><span class="p">):</span>
        <span class="n">bfs_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">origin_id</span><span class="p">)</span>
        <span class="n">bfs_tree</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">g_g_primes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rhs_g_primes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="n">bfs_tree</span><span class="p">:</span>

            <span class="n">origin_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>

            <span class="n">rhs_graph_typing</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">graph</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">rhs_graph_typing</span> <span class="o">=</span> <span class="n">rhs_typing</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span>

            <span class="n">g_g_prime</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="n">rhs_g_prime</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">p_origin_m</span><span class="p">,</span> <span class="n">origin_typing</span><span class="p">)</span>

            <span class="n">pred_typings</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">p</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">adj_relations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacent_relations</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="c1"># Propagate node merges</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">merged_nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_merge</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">p_origin_m</span><span class="p">,</span> <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">rhs_g_prime</span><span class="p">)</span>

            <span class="c1"># Propagate node additions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">added_nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_node_addition</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">rhs_graph_typing</span><span class="p">,</span>
                    <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">rhs_g_prime</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_update_incident_homs</span><span class="p">(</span>
                <span class="n">graph</span><span class="p">,</span> <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">pred_typings</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_update_incident_rels</span><span class="p">(</span>
                <span class="n">graph</span><span class="p">,</span> <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">adj_relations</span><span class="p">)</span>

            <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">keys_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                        <span class="n">keys_to_add</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">p_rhs</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keys_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="c1"># Propagate node attrs additions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">added_node_attrs</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_node_attrs_addition</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">rhs_g_prime</span><span class="p">)</span>

            <span class="c1"># Propagate edge additions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">added_edges</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_edge_addition</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">rhs_g_prime</span><span class="p">)</span>

            <span class="c1"># Propagate edge attrs additions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">added_edge_attrs</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_edge_attrs_addition</span><span class="p">(</span>
                    <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                    <span class="n">rhs_g_prime</span><span class="p">)</span>

            <span class="n">g_g_primes</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_g_prime</span>
            <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_g_prime</span>

        <span class="c1"># Perform an expansive rewrite</span>
        <span class="n">rhs_origin_prime</span><span class="p">,</span> <span class="n">origin_m_origin_prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expansive_rewrite</span><span class="p">(</span>
            <span class="n">origin_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">)</span>

        <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">origin_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_origin_prime</span>
        <span class="n">g_g_primes</span><span class="p">[</span><span class="n">origin_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin_m_origin_prime</span>

        <span class="c1"># Reconnect broken homomorphisms by composability</span>
        <span class="k">for</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_g_prime</span> <span class="ow">in</span> <span class="n">g_g_primes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">suc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                <span class="n">suc_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">suc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">rhs_node</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="n">g_nodes</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                        <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">graph_id</span><span class="p">][</span><span class="n">rhs_node</span><span class="p">])</span>

                    <span class="n">suc_node</span> <span class="o">=</span> <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">suc</span><span class="p">][</span><span class="n">rhs_node</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g_nodes</span><span class="p">:</span>
                        <span class="n">suc_typing</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">suc_node</span>

                <span class="n">graph_suc</span> <span class="o">=</span> <span class="n">get_unique_map_from_pushout</span><span class="p">(</span>
                    <span class="n">graph_nodes</span><span class="p">,</span>
                    <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">graph_id</span><span class="p">],</span>
                    <span class="n">g_g_prime</span><span class="p">,</span>
                    <span class="n">rhs_g_primes</span><span class="p">[</span><span class="n">suc</span><span class="p">],</span>
                    <span class="n">suc_typing</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">suc</span><span class="p">,</span> <span class="n">graph_suc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rhs_origin_prime</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_produce_clones</span><span class="p">(</span><span class="n">origin_clones</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">origin_typing</span><span class="p">,</span> <span class="n">graph_p</span><span class="p">,</span>
                        <span class="n">local_g_m_g</span><span class="p">,</span> <span class="n">local_g_m_origin_m</span><span class="p">):</span>
        <span class="n">cloned_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">clones</span> <span class="ow">in</span> <span class="n">origin_clones</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nodes_to_clone</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">origin_typing</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_to_clone</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">p_nodes</span> <span class="o">=</span> <span class="n">graph_p</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p_nodes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">keys_by_value</span><span class="p">(</span><span class="n">p_origin_m</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clones</span>
                    <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_nodes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cloned_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_node</span>
                        <span class="n">local_g_m_g</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
                        <span class="n">local_g_m_origin_m</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_origin_m</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">clone_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">cloned_nodes</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_node</span>
                        <span class="n">local_g_m_g</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
                        <span class="n">local_g_m_origin_m</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_origin_m</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cloned_nodes</span>

    <span class="k">def</span> <span class="nf">_propagate_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                         <span class="n">origin_m_origin</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span>
                         <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate clones from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a controlled propagation of clones to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        p_origin_m : dict</span>
<span class="sd">            Instance of rule&#39;s interface inside the updated origin</span>
<span class="sd">        origin_m_origin : dict</span>
<span class="sd">            Map from the updated origin to the initial origin</span>
<span class="sd">        p_typing : dict</span>
<span class="sd">            Controlling relation from the nodes of &#39;graph_id&#39; to</span>
<span class="sd">            the nodes of the interfaces</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        g_m_g : dict</span>
<span class="sd">            Map from the updated &#39;graph_id&#39; to the &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cloned_origin_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">origin_m_origin</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">clones</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">origin_m_origin</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cloned_origin_nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">clones</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">origin_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">)</span>

        <span class="n">cloned_origin_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">origin_m_origin</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">clones</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">origin_m_origin</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cloned_origin_nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">clones</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_produce_clones</span><span class="p">(</span>
            <span class="n">cloned_origin_nodes</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">,</span> <span class="n">origin_typing</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">,</span>
            <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_homs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_rels</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span>

    <span class="k">def</span> <span class="nf">_propagate_node_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
                                <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate node removal from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        origin_m_origin : dict</span>
<span class="sd">            Map from the updated origin to the initial origin</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        g_m_g : dict</span>
<span class="sd">            Map from the updated &#39;graph_id&#39; to the &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">origin_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lhs_node</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">removed_nodes</span><span class="p">():</span>
            <span class="n">origin_n</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="n">lhs_node</span><span class="p">]</span>
            <span class="n">graph_nodes</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">origin_typing</span><span class="p">,</span> <span class="n">origin_n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_nodes</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">g_m_g</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">g_m_origin_m</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">origin_typing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">g_m_g</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">g_m_origin_m</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_homs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrictive_update_incident_rels</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g_m_g</span><span class="p">,</span> <span class="n">g_m_origin_m</span>

    <span class="k">def</span> <span class="nf">_propagate_node_attrs_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                      <span class="n">p_origin_m</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate node attrs removal from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        instance : dict</span>
<span class="sd">            Original instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="c1"># origin_typing = self.get_typing(node_id, origin_id)</span>
        <span class="k">for</span> <span class="n">p_node</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">removed_node_attrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nodes_to_remove_attrs</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span>
                <span class="n">g_m_origin_m</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">[</span><span class="n">p_node</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_to_remove_attrs</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">remove_node_attrs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_edge_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_origin_m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate edge removal from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        node_id : hashable</span>
<span class="sd">            ID of the node where propagation is performed</span>
<span class="sd">        p_origin_m : dict</span>
<span class="sd">            Instance of rule&#39;s interface inside the updated origin</span>
<span class="sd">        origin_m_origin : dict</span>
<span class="sd">            Map from the updated origin to the initial origin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">origin_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">origin_id</span><span class="p">)</span>

        <span class="n">edges_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">origin_s</span> <span class="o">=</span> <span class="n">g_m_origin_m</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">origin_t</span> <span class="o">=</span> <span class="n">g_m_origin_m</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">origin_s</span><span class="p">,</span> <span class="n">origin_t</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">origin_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">edges_to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">edges_to_remove</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_edge_attrs_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                                      <span class="n">g_m_origin_m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate edge attrs removal from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        p_origin_m : dict</span>
<span class="sd">            Instance of rule&#39;s interface inside the updated origin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">p_u</span><span class="p">,</span> <span class="n">p_v</span><span class="p">),</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">removed_edge_attrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">us</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">g_m_origin_m</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">[</span><span class="n">p_u</span><span class="p">])</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">g_m_origin_m</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">[</span><span class="n">p_v</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">us</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                        <span class="n">graph</span><span class="o">.</span><span class="n">remove_edge_attrs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">p_origin_m</span><span class="p">,</span>
                         <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">rhs_g_prime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate merges from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a propagation of merges to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        p_origin_m : dict</span>
<span class="sd">            Instance of rule&#39;s interface inside the updated origin</span>
<span class="sd">        rhs_origin_prime : dict</span>
<span class="sd">            Instance of rule&#39;s rhs inside the updated origin</span>
<span class="sd">        g_g_prime : dict</span>
<span class="sd">            Map from the nodes of the graph &#39;graph_id&#39; to the updated graph</span>
<span class="sd">        rhs_g_prime : dict</span>
<span class="sd">            Map from the RHS to the updated graph with &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rhs_node</span><span class="p">,</span> <span class="n">p_nodes</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">merged_nodes</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span>
            <span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">merged_node_id</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">merge_nodes</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph_nodes</span><span class="p">:</span>
                    <span class="n">g_g_prime</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_node_id</span>
                <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_node_id</span>
                <span class="n">map_to_merge_node</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">rhs_n</span><span class="p">,</span> <span class="n">g_prime_n</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">g_prime_n</span> <span class="ow">in</span> <span class="n">graph_nodes</span><span class="p">:</span>
                        <span class="n">map_to_merge_node</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rhs_n</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">map_to_merge_node</span><span class="p">:</span>
                    <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_node_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_propagate_node_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                 <span class="n">rhs_typing</span><span class="p">,</span> <span class="n">g_g_prime</span><span class="p">,</span> <span class="n">rhs_g_prime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate node additions from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a propagation of additions to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        rhs_origin_prime : dict</span>
<span class="sd">            Instance of rule&#39;s rhs inside the updated origin</span>
<span class="sd">        rhs_typing : dict</span>
<span class="sd">            Typing of the nodes from the rhs in &#39;graph_id&#39;</span>
<span class="sd">        rhs_g_prime : dict</span>
<span class="sd">            Map from the RHS to the updated graph with &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rhs_node</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">added_nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rhs_node</span> <span class="ow">in</span> <span class="n">rhs_typing</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs_typing</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">rhs_typing</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nodes_to_merge</span> <span class="o">=</span> <span class="n">rhs_typing</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span>
                    <span class="n">new_node_id</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">merge_nodes</span><span class="p">(</span><span class="n">nodes_to_merge</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_to_merge</span><span class="p">:</span>
                        <span class="n">g_g_prime</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node_id</span>
                        <span class="n">p_nodes</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">rhs_g_prime</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">p_nodes</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span>
                    <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node_id</span>
                    <span class="n">map_to_merge_node</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">rhs_n</span><span class="p">,</span> <span class="n">g_prime_n</span> <span class="ow">in</span> <span class="n">rhs_g_prime</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">g_prime_n</span> <span class="ow">in</span> <span class="n">nodes_to_merge</span><span class="p">:</span>
                            <span class="n">map_to_merge_node</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rhs_n</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">map_to_merge_node</span><span class="p">:</span>
                        <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_node_id</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">generate_new_node_id</span><span class="p">(</span><span class="n">rhs_node</span><span class="p">)</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">new_node_id</span><span class="p">)</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node_id</span>

    <span class="k">def</span> <span class="nf">_propagate_node_attrs_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                       <span class="n">rhs_g_prime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate node attrs additions from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a propagation of additions to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        rhs_origin_prime : dict</span>
<span class="sd">            Instance of rule&#39;s rhs inside the updated origin</span>
<span class="sd">        origin_prime_g_prime : dict</span>
<span class="sd">            Map from the updated origin to the updated graph with &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rhs_node</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">added_node_attrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_node_attrs</span><span class="p">(</span>
                <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">rhs_node</span><span class="p">],</span>
                <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_edge_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                 <span class="n">rhs_g_prime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate edge additions from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a propagation of additions to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        rule : regraph.Rule</span>
<span class="sd">            Original rewriting rule</span>
<span class="sd">        rhs_origin_prime : dict</span>
<span class="sd">            Instance of rule&#39;s rhs inside the updated origin</span>
<span class="sd">        origin_prime_g_prime : dict</span>
<span class="sd">            Map from the updated origin to the updated graph with &#39;graph_id&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">added_edges</span><span class="p">():</span>
            <span class="n">g_s</span> <span class="o">=</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">g_t</span> <span class="o">=</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g_s</span><span class="p">,</span> <span class="n">g_t</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">g_s</span><span class="p">,</span> <span class="n">g_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_propagate_edge_attrs_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_id</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span>
                                       <span class="n">rhs_g_prime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate edge attrs additions from &#39;origin_id&#39; to &#39;graph_id&#39;.</span>

<span class="sd">        Perform a propagation of additions to &#39;graph&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin_id : hashable</span>
<span class="sd">            ID of the graph corresponding to the origin of rewriting</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            ID of the graph where propagation is performed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">added_edge_attrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">g_s</span> <span class="o">=</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">g_t</span> <span class="o">=</span> <span class="n">rhs_g_prime</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_attrs</span><span class="p">(</span><span class="n">g_s</span><span class="p">,</span> <span class="n">g_t</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_identity_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_restrictive_update_incident_homs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">suc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">node_id</span><span class="p">):</span>
            <span class="n">typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">suc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">suc</span><span class="p">,</span> <span class="n">compose</span><span class="p">(</span><span class="n">g_m_g</span><span class="p">,</span> <span class="n">typing</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_restrictive_update_incident_rels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">related_g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacent_relations</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">related_g</span><span class="p">)</span>
            <span class="n">new_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="n">old_node</span> <span class="o">=</span> <span class="n">g_m_g</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">old_node</span> <span class="ow">in</span> <span class="n">rel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">new_rel</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="n">old_node</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_relation</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">related_g</span><span class="p">,</span> <span class="n">new_rel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expansive_update_incident_homs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g_prime</span><span class="p">,</span>
                                        <span class="n">pred_typings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">pred_typings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_mapping</span><span class="p">(</span>
                <span class="n">pred</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">compose</span><span class="p">(</span><span class="n">typing</span><span class="p">,</span> <span class="n">g_m_g_prime</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_expansive_update_incident_rels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">g_m_g_prime</span><span class="p">,</span>
                                        <span class="n">adj_relations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">related_g</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">adj_relations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g_m_g_prime</span><span class="p">:</span>
                    <span class="n">new_node</span> <span class="o">=</span> <span class="n">g_m_g_prime</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">new_rel</span><span class="p">[</span><span class="n">new_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_relation</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">related_g</span><span class="p">,</span> <span class="n">new_rel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_applicability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_hierarchy</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a rule hierarchy is applicable.&quot;&quot;&quot;</span>
        <span class="c1"># Check that instances commute</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">():</span>
            <span class="n">typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">lhs_s_t1</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">instances</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">typing</span><span class="p">)</span>
            <span class="n">lhs_s_t2</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span>
                <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rule_homomorphisms&quot;</span><span class="p">][(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">instances</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lhs_s_t1</span> <span class="o">!=</span> <span class="n">lhs_s_t2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                    <span class="s2">&quot;Instance of a specified rule for &#39;</span><span class="si">{}</span><span class="s2">&#39; (</span><span class="si">{}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">s</span><span class="p">,</span> <span class="n">instances</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">+</span>
                    <span class="s2">&quot;is not compatible with such instance for &#39;</span><span class="si">{}</span><span class="s2">&#39; (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">t</span><span class="p">,</span> <span class="n">instances</span><span class="p">[</span><span class="n">t</span><span class="p">]))</span>

            <span class="c1"># Check the applicability</span>
            <span class="n">t_rule</span> <span class="o">=</span> <span class="n">rule_hierarchy</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t_rule</span><span class="o">.</span><span class="n">is_restrictive</span><span class="p">():</span>
                <span class="c1"># Check the square L_S -&gt; S -&gt; T and L_S -&gt; L_T -&gt; T is a PB</span>
                <span class="k">for</span> <span class="n">lhs_t_node</span> <span class="ow">in</span> <span class="n">t_rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="n">t_node</span> <span class="o">=</span> <span class="n">instances</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">lhs_t_node</span><span class="p">]</span>
                    <span class="n">s_nodes</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">typing</span><span class="p">,</span> <span class="n">t_node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lhs_t_node</span> <span class="ow">in</span> <span class="n">t_rule</span><span class="o">.</span><span class="n">removed_nodes</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">s_node</span> <span class="ow">in</span> <span class="n">s_nodes</span><span class="p">:</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">s_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">instances</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s_node</span><span class="p">)[</span>
                                    <span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_hierarchy</span><span class="p">[</span>
                                        <span class="s2">&quot;rules&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">removed_nodes</span><span class="p">():</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                                    <span class="s2">&quot;Specified rule hierarchy is not applicable &quot;</span>
                                    <span class="s2">&quot;the typing of the node &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_node</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;from the graph &#39;</span><span class="si">{}</span><span class="s2">&#39; is removed &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;by rewriting of &#39;</span><span class="si">{}</span><span class="s2">&#39;, but &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;this node is not removed by the rule &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;applied to &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                <span class="p">)</span>

                    <span class="k">if</span> <span class="n">lhs_t_node</span> <span class="ow">in</span> <span class="n">t_rule</span><span class="o">.</span><span class="n">cloned_nodes</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">s_node</span> <span class="ow">in</span> <span class="n">s_nodes</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                                    <span class="s2">&quot;Specified rule hierarchy is not applicable &quot;</span>
                                    <span class="s2">&quot;the typing of the node &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_node</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;from the graph &#39;</span><span class="si">{}</span><span class="s2">&#39; is cloned &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;by rewriting of &#39;</span><span class="si">{}</span><span class="s2">&#39;, but the &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;retyping of this node is not specified, i.e. &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is not in the instances of &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_node</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s2">&quot;the rule applied to &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                <span class="p">)</span>

<div class="viewcode-block" id="Hierarchy.relabel_nodes"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.relabel_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel nodes of a graph in the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">relabel_nodes</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hierarchy.graphs_typed_by_node"><a class="viewcode-back" href="../../hierarchies.html#regraph.hierarchies.Hierarchy.graphs_typed_by_node">[docs]</a>    <span class="k">def</span> <span class="nf">graphs_typed_by_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get graphs typed by &#39;node_id&#39; in &#39;graph_id&#39;.&quot;&quot;&quot;</span>
        <span class="n">graphs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
            <span class="n">p_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">p_typing</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graphs</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ReGraph</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Eugenia Oshurko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>