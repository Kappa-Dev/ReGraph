
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>regraph.backends.neo4j.hierarchies &#8212; ReGraph 3.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for regraph.backends.neo4j.hierarchies</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Neo4j-based persisent graph hierarchies.</span>

<span class="sd">This module implements data structures that allow working with persistent</span>
<span class="sd">graph hierarchies stored in an instance of the Neo4j database:</span>

<span class="sd">* `Neo4jHierarchy` -- class for persistent graph hierarchies.</span>
<span class="sd">* `TypedNeo4jGraph` -- class for schema-aware property graph.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">neo4j.v1</span> <span class="k">import</span> <span class="n">GraphDatabase</span>
<span class="kn">from</span> <span class="nn">neo4j.exceptions</span> <span class="k">import</span> <span class="n">ConstraintError</span>

<span class="kn">from</span> <span class="nn">regraph.rules</span> <span class="k">import</span> <span class="n">Rule</span>
<span class="kn">from</span> <span class="nn">regraph.backends.networkx.graphs</span> <span class="k">import</span> <span class="n">NXGraph</span>
<span class="kn">from</span> <span class="nn">regraph.exceptions</span> <span class="k">import</span> <span class="p">(</span><span class="n">HierarchyError</span><span class="p">,</span>
                                <span class="n">InvalidHomomorphism</span><span class="p">,</span>
                                <span class="n">ReGraphError</span><span class="p">,</span>
                                <span class="n">ReGraphWarning</span><span class="p">,</span>
                                <span class="n">RewritingError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">regraph.hierarchies</span> <span class="k">import</span> <span class="n">Hierarchy</span>
<span class="kn">from</span> <span class="nn">regraph.backends.neo4j.graphs</span> <span class="k">import</span> <span class="n">Neo4jGraph</span>
<span class="kn">from</span> <span class="nn">.cypher_utils.generic</span> <span class="k">import</span> <span class="p">(</span><span class="n">constraint_query</span><span class="p">,</span>
                                   <span class="n">get_nodes</span><span class="p">,</span>
                                   <span class="n">get_edges</span><span class="p">,</span>
                                   <span class="n">clear_graph</span><span class="p">,</span>
                                   <span class="n">successors_query</span><span class="p">,</span>
                                   <span class="n">predecessors_query</span><span class="p">,</span>
                                   <span class="n">get_edge_attrs</span><span class="p">,</span>
                                   <span class="n">properties_to_attributes</span><span class="p">,</span>
                                   <span class="n">get_node_attrs</span><span class="p">,</span>
                                   <span class="n">set_attributes</span><span class="p">,</span>
                                   <span class="n">match_nodes</span><span class="p">,</span>
                                   <span class="n">with_vars</span><span class="p">,</span>
                                   <span class="n">match_node</span><span class="p">,</span>
                                   <span class="n">shortest_path_query</span><span class="p">,</span>
                                   <span class="n">match_edge</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cypher_utils.propagation</span> <span class="k">import</span> <span class="p">(</span><span class="n">set_intergraph_edge</span><span class="p">,</span>
                                       <span class="n">check_homomorphism</span><span class="p">,</span>
                                       <span class="n">check_consistency</span><span class="p">,</span>
                                       <span class="n">get_typing</span><span class="p">,</span>
                                       <span class="n">get_relation</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cypher_utils.rewriting</span> <span class="k">import</span> <span class="p">(</span><span class="n">add_edge</span><span class="p">,</span>
                                     <span class="n">remove_nodes</span><span class="p">,</span>
                                     <span class="n">remove_edge</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">regraph.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">normalize_attrs</span><span class="p">,</span>
                           <span class="n">attrs_from_json</span><span class="p">,</span>
                           <span class="n">normalize_relation</span><span class="p">,</span>
                           <span class="n">valid_attributes</span><span class="p">,</span>
                           <span class="n">keys_by_value</span><span class="p">)</span>


<div class="viewcode-block" id="Neo4jHierarchy"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy">[docs]</a><span class="k">class</span> <span class="nc">Neo4jHierarchy</span><span class="p">(</span><span class="n">Hierarchy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for persistent hierarchies.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Implementation of abstract methods</span>

<div class="viewcode-block" id="Neo4jHierarchy.graphs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.graphs">[docs]</a>    <span class="k">def</span> <span class="nf">graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of graphs in the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_nodes</span><span class="p">(</span><span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">graphs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;node_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;node_id&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">graphs</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.typings"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.typings">[docs]</a>    <span class="k">def</span> <span class="nf">typings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of graph typing edges in the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_edges</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">typings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">typings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">typings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">typings</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.relations"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.relations">[docs]</a>    <span class="k">def</span> <span class="nf">relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of relations.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_edges</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">relations</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.successors"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.successors">[docs]</a>    <span class="k">def</span> <span class="nf">successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of successors.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">successors_query</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                                 <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="p">,</span>
                                 <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
                                 <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span>
        <span class="n">succ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">succ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">succ</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.predecessors"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.predecessors">[docs]</a>    <span class="k">def</span> <span class="nf">predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of predecessors.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">predecessors_query</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                                   <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="p">,</span>
                                   <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
                                   <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">preds</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a graph object associated to the node &#39;graph_id&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_typing"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_typing">[docs]</a>    <span class="k">def</span> <span class="nf">get_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a typing dict associated to the edge &#39;source_id-&gt;target_id&#39;.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_typing</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">typing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">source_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="n">target_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_nodes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">type_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">type_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_nodes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">type_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">type_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">typing</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_id</span>
        <span class="k">return</span> <span class="n">typing</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_relation"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_relation">[docs]</a>    <span class="k">def</span> <span class="nf">get_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_id</span><span class="p">,</span> <span class="n">right_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a relation dict associated to the rel &#39;left_id-&gt;target_id&#39;.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_relation</span><span class="p">(</span><span class="n">left_id</span><span class="p">,</span> <span class="n">right_id</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">relation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">relation</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relation</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">relation</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_graph_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_graph_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_node_attrs</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="s2">&quot;attributes&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">properties_to_attributes</span><span class="p">(</span>
            <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.set_graph_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.set_graph_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">set_graph_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skeleton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span>
        <span class="n">skeleton</span><span class="o">.</span><span class="n">set_node_attrs</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_typing_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_typing_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">get_typing_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a typing in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_edge_attrs</span><span class="p">(</span>
            <span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">,</span>
            <span class="s2">&quot;attributes&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">properties_to_attributes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.set_typing_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.set_typing_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">set_typing_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a typing in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skeleton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span>
        <span class="n">skeleton</span><span class="o">.</span><span class="n">set_edge_attrs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.get_relation_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.get_relation_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">get_relation_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_id</span><span class="p">,</span> <span class="n">right_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attributes of a reltion in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left : hashable</span>
<span class="sd">            Id of the left graph</span>
<span class="sd">        right : hashable</span>
<span class="sd">            Id of the right graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_edge_attrs</span><span class="p">(</span>
            <span class="n">left_id</span><span class="p">,</span> <span class="n">right_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span><span class="p">,</span>
            <span class="s2">&quot;attributes&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">properties_to_attributes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.set_relation_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.set_relation_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">set_relation_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set attributes of a relation in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left : hashable</span>
<span class="sd">            Id of the left graph</span>
<span class="sd">        right : hashable</span>
<span class="sd">            Id of the right graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skeleton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span><span class="p">)</span>
        <span class="n">skeleton</span><span class="o">.</span><span class="n">set_edge_attrs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.set_node_relation"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.set_node_relation">[docs]</a>    <span class="k">def</span> <span class="nf">set_node_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left_graph</span><span class="p">,</span> <span class="n">right_graph</span><span class="p">,</span> <span class="n">left_node</span><span class="p">,</span>
                          <span class="n">right_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set relation for a particular node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">set_intergraph_edge</span><span class="p">(</span>
            <span class="n">left_graph</span><span class="p">,</span> <span class="n">right_graph</span><span class="p">,</span> <span class="n">left_node</span><span class="p">,</span> <span class="n">right_node</span><span class="p">,</span>
            <span class="s2">&quot;relation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.add_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.add_graph">[docs]</a>    <span class="k">def</span> <span class="nf">add_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new graph to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        graph : regraph.Graph</span>
<span class="sd">            Graph object corresponding to the new node of</span>
<span class="sd">            the hierarchy</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_graph_from_data</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.add_graph_from_data"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.add_graph_from_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_graph_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">edge_list</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new graph to the hierarchy from the input node/edge lists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        node_list : iterable</span>
<span class="sd">            List of nodes (with attributes)</span>
<span class="sd">        edge_list : iterable</span>
<span class="sd">            List of edges (with attributes)</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a node in the hierarchy</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;CREATE (</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> {{ id : &#39;</span><span class="si">{}</span><span class="s2">&#39; }}) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;new_graph&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
                <span class="n">graph_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="n">set_attributes</span><span class="p">(</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;new_graph&#39;</span><span class="p">,</span>
                    <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span><span class="p">(</span><span class="n">ConstraintError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;The graph &#39;</span><span class="si">{}</span><span class="s2">&#39; is already in the database.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Neo4jGraph</span><span class="p">(</span>
            <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">,</span>
            <span class="n">node_label</span><span class="o">=</span><span class="n">graph_id</span><span class="p">,</span>
            <span class="n">unique_node_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edge_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edge_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.add_empty_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.add_empty_graph">[docs]</a>    <span class="k">def</span> <span class="nf">add_empty_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Add a new empty graph to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of a new node in the hierarchy</span>
<span class="sd">        graph_attrs : dict, optional</span>
<span class="sd">            Dictionary containing attributes of the new node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_graph_from_data</span><span class="p">(</span>
            <span class="n">graph_id</span><span class="p">,</span> <span class="n">node_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">edge_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.add_typing"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.add_typing">[docs]</a>    <span class="k">def</span> <span class="nf">add_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add homomorphism to the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : hashable</span>
<span class="sd">            Id of the source graph node of typing</span>
<span class="sd">        target : hashable</span>
<span class="sd">            Id of the target graph node of typing</span>
<span class="sd">        mapping : dict</span>
<span class="sd">            Dictionary representing a mapping of nodes</span>
<span class="sd">            from the source graph to target&#39;s nodes</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            Dictionary containing attributes of the new</span>
<span class="sd">            typing edge</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            This error is raised in the following cases:</span>

<span class="sd">                * source or target ids are not found in the hierarchy</span>
<span class="sd">                * a typing edge between source and target already exists</span>
<span class="sd">                * addition of an edge between source and target creates</span>
<span class="sd">                a cycle or produces paths that do not commute with</span>
<span class="sd">                some already existing paths</span>

<span class="sd">        InvalidHomomorphism</span>
<span class="sd">            If a homomorphisms from a graph at the source to a graph at</span>
<span class="sd">            the target given by `mapping` is not a valid homomorphism.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tmp_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tmp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true&#39;</span><span class="p">}}</span>
        <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">tmp_attrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">set_intergraph_edge</span><span class="p">(</span>
                            <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                            <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span>
                            <span class="n">attrs</span><span class="o">=</span><span class="n">tmp_attrs</span><span class="p">))</span>
                    <span class="n">tx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">tx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">valid_typing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">paths_commute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="c1"># We first check that the homorphism is valid</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">()</span>
                    <span class="n">valid_typing</span> <span class="o">=</span> <span class="n">check_homomorphism</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                    <span class="n">tx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">InvalidHomomorphism</span> <span class="k">as</span> <span class="n">homomorphism_error</span><span class="p">:</span>
                <span class="n">valid_typing</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">del_query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (:</span><span class="si">{}</span><span class="s2">)-[t:typing]-(:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;DELETE t</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">del_query</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">homomorphism_error</span>
            <span class="c1"># We then check that the new typing preserv consistency</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">()</span>
                    <span class="n">paths_commute</span> <span class="o">=</span> <span class="n">check_consistency</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                    <span class="n">tx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">InvalidHomomorphism</span> <span class="k">as</span> <span class="n">consistency_error</span><span class="p">:</span>
                <span class="n">paths_commute</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">del_query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (:</span><span class="si">{}</span><span class="s2">)-[t:typing]-(:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;DELETE t</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">del_query</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">consistency_error</span>

        <span class="k">if</span> <span class="n">valid_typing</span> <span class="ow">and</span> <span class="n">paths_commute</span><span class="p">:</span>
            <span class="n">skeleton_query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">match_nodes</span><span class="p">(</span>
                    <span class="n">var_id_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;g_src&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;g_tar&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">},</span>
                    <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">edge_var</span><span class="o">=</span><span class="s1">&#39;new_hierarchy_edge&#39;</span><span class="p">,</span>
                    <span class="n">source_var</span><span class="o">=</span><span class="s1">&#39;g_src&#39;</span><span class="p">,</span>
                    <span class="n">target_var</span><span class="o">=</span><span class="s1">&#39;g_tar&#39;</span><span class="p">,</span>
                    <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">,</span>
                    <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">with_vars</span><span class="p">([</span><span class="s2">&quot;new_hierarchy_edge&quot;</span><span class="p">])</span> <span class="o">+</span>
                <span class="s2">&quot;MATCH (:</span><span class="si">{}</span><span class="s2">)-[t:typing]-(:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;REMOVE t.tmp</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">skeleton_query</span><span class="p">)</span></div>
        <span class="c1"># return result</span>

<div class="viewcode-block" id="Neo4jHierarchy.add_relation"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.add_relation">[docs]</a>    <span class="k">def</span> <span class="nf">add_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add relation to the hierarchy.</span>

<span class="sd">        This method adds a relation between two graphs in</span>
<span class="sd">        the hierarchy corresponding to the nodes with ids</span>
<span class="sd">        `left` and `right`, the relation itself is defined</span>
<span class="sd">        by a dictionary `relation`, where a key is a node in</span>
<span class="sd">        the `left` graph and its corresponding value is a set</span>
<span class="sd">        of nodes from the `right` graph to which the node is</span>
<span class="sd">        related. Relations in the hierarchy are symmetric</span>
<span class="sd">        (see example below).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        left</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `left` graph</span>
<span class="sd">        right</span>
<span class="sd">            Id of the hierarchy&#39;s node represening the `right` graph</span>
<span class="sd">        relation : dict</span>
<span class="sd">            Dictionary representing a relation of nodes from `left`</span>
<span class="sd">            to the nodes from `right`, a key of the dictionary is</span>
<span class="sd">            assumed to be a node from `left` and its value a set</span>
<span class="sd">            of ids of related nodes from `right`</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            Dictionary containing attributes of the new relation</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            This error is raised in the following cases:</span>

<span class="sd">                * node with id `left`/`right` is not defined in the hierarchy;</span>
<span class="sd">                * node with id `left`/`right` is not a graph;</span>
<span class="sd">                * a relation between `left` and `right` already exists;</span>
<span class="sd">                * some node ids specified in `relation` are not found in the</span>
<span class="sd">                `left`/`right` graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_rel</span> <span class="o">=</span> <span class="n">normalize_relation</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">new_rel</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (u:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}}), (v:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">left</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">add_edge</span><span class="p">(</span>
                        <span class="n">edge_var</span><span class="o">=</span><span class="s2">&quot;rel&quot;</span><span class="p">,</span>
                        <span class="n">source_var</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
                        <span class="n">target_var</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
                        <span class="n">edge_label</span><span class="o">=</span><span class="s2">&quot;relation&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># query = &quot;&quot;</span>
        <span class="c1"># rel_creation_queries = []</span>
        <span class="c1"># nodes_to_match_left = set()</span>
        <span class="c1"># nodes_to_match_right = set()</span>
        <span class="c1"># for key, values in relation.items():</span>
        <span class="c1">#     nodes_to_match_left.add(key)</span>
        <span class="c1">#     for value in values:</span>
        <span class="c1">#         nodes_to_match_right.add(value)</span>
        <span class="c1">#         rel_creation_queries.append(</span>
        <span class="c1">#             add_edge(</span>
        <span class="c1">#                 edge_var=&quot;rel_&quot; + key + &quot;_&quot; + value,</span>
        <span class="c1">#                 source_var=&quot;n&quot; + key + &quot;_left&quot;,</span>
        <span class="c1">#                 target_var=&quot;n&quot; + value + &quot;_right&quot;,</span>
        <span class="c1">#                 edge_label=&quot;relation&quot;))</span>

        <span class="c1"># if len(nodes_to_match_left) &gt; 0:</span>
        <span class="c1">#     query += match_nodes(</span>
        <span class="c1">#         {&quot;n&quot; + n + &quot;_left&quot;: n for n in nodes_to_match_left},</span>
        <span class="c1">#         node_label=g_left._node_label)</span>
        <span class="c1">#     query += with_vars(</span>
        <span class="c1">#         [&quot;n&quot; + s + &quot;_left&quot; for s in nodes_to_match_left])</span>
        <span class="c1">#     query += match_nodes(</span>
        <span class="c1">#         {&quot;n&quot; + n + &quot;_right&quot;: n for n in nodes_to_match_right},</span>
        <span class="c1">#         node_label=g_right._node_label)</span>
        <span class="c1">#     for q in rel_creation_queries:</span>
        <span class="c1">#         query += q</span>
        <span class="c1"># print(query)</span>
        <span class="c1"># rel_addition_result = self.execute(query)</span>

        <span class="n">skeleton_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">match_nodes</span><span class="p">(</span>
                <span class="n">var_id_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;g_left&#39;</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span> <span class="s1">&#39;g_right&#39;</span><span class="p">:</span> <span class="n">right</span><span class="p">},</span>
                <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">add_edge</span><span class="p">(</span>
                <span class="n">edge_var</span><span class="o">=</span><span class="s1">&#39;new_hierarchy_edge&#39;</span><span class="p">,</span>
                <span class="n">source_var</span><span class="o">=</span><span class="s1">&#39;g_left&#39;</span><span class="p">,</span>
                <span class="n">target_var</span><span class="o">=</span><span class="s1">&#39;g_right&#39;</span><span class="p">,</span>
                <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span><span class="p">,</span>
                <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">skeleton_addition_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">skeleton_query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">skeleton_addition_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.remove_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.remove_graph">[docs]</a>    <span class="k">def</span> <span class="nf">remove_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove graph from the hierarchy.</span>

<span class="sd">        Removes a graph from the hierarchy, if the `reconnect`</span>
<span class="sd">        parameter is set to True, adds typing from the</span>
<span class="sd">        predecessors of the removed node to all its successors,</span>
<span class="sd">        by composing the homomorphisms (for every predecessor `p`</span>
<span class="sd">        and for every successor &#39;s&#39; composes two homomorphisms</span>
<span class="sd">        `p`-&gt;`node_id` and `node_id`-&gt;`s`, then removes `node_id` and</span>
<span class="sd">        all its incident edges, by which makes node&#39;s</span>
<span class="sd">        removal a procedure of &#39;forgetting&#39; one level</span>
<span class="sd">        of &#39;abstraction&#39;).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node_id</span>
<span class="sd">            Id of a graph to remove</span>
<span class="sd">        reconnect : bool</span>
<span class="sd">            Reconnect the descendants of the removed node to</span>
<span class="sd">            its predecessors</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If graph with `node_id` is not defined in the hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reconnect</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;OPTIONAL MATCH (pred)-[:typing]-&gt;(n)-[:typing]-&gt;(suc)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;WITH pred, suc WHERE pred IS NOT NULL</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">edge_var</span><span class="o">=</span><span class="s1">&#39;reconnect_typing&#39;</span><span class="p">,</span>
                    <span class="n">source_var</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span>
                    <span class="n">target_var</span><span class="o">=</span><span class="s1">&#39;suc&#39;</span><span class="p">,</span>
                    <span class="n">edge_label</span><span class="o">=</span><span class="s2">&quot;typing&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># Clear the graph and drop the constraint on the ids</span>
        <span class="n">g</span><span class="o">.</span><span class="n">_drop_constraint</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="c1"># Remove the graph (and reconnect if True)</span>
        <span class="k">if</span> <span class="n">reconnect</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">match_node</span><span class="p">(</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;graph_to_rm&quot;</span><span class="p">,</span>
                    <span class="n">node_id</span><span class="o">=</span><span class="n">graph_id</span><span class="p">,</span>
                    <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;OPTIONAL MATCH (pred)-[:</span><span class="si">{}</span><span class="s2">]-&gt;(n)-[:</span><span class="si">{}</span><span class="s2">]-&gt;(suc)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;WITH pred, suc WHERE pred IS NOT NULL</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">edge_var</span><span class="o">=</span><span class="s1">&#39;reconnect_typing&#39;</span><span class="p">,</span>
                    <span class="n">source_var</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span>
                    <span class="n">target_var</span><span class="o">=</span><span class="s1">&#39;suc&#39;</span><span class="p">,</span>
                    <span class="n">edge_label</span><span class="o">=</span><span class="s2">&quot;typing&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">match_node</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;graph_to_rm&quot;</span><span class="p">,</span>
                           <span class="n">node_id</span><span class="o">=</span><span class="n">graph_id</span><span class="p">,</span>
                           <span class="n">node_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="n">remove_nodes</span><span class="p">([</span><span class="s2">&quot;graph_to_rm&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.remove_typing"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.remove_typing">[docs]</a>    <span class="k">def</span> <span class="nf">remove_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a typing from the hierarchy.&quot;&quot;&quot;</span>
        <span class="c1"># Clean-up the represenation of the homomorphism</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MATCH (:</span><span class="si">{}</span><span class="s2">)-[r:</span><span class="si">{}</span><span class="s2">]-&gt;(:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span>
            <span class="s2">&quot;DELETE r</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># Remove the corresponding edge from the skeleton</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">match_edge</span><span class="p">(</span>
            <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="n">remove_edge</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.remove_relation"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.remove_relation">[docs]</a>    <span class="k">def</span> <span class="nf">remove_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a relation from the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MATCH (:</span><span class="si">{}</span><span class="s2">)-[r:</span><span class="si">{}</span><span class="s2">]-(:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_relation_label</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="o">+</span>
            <span class="s2">&quot;DELETE r</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># Remove the corresponding edge from the skeleton</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">match_edge</span><span class="p">(</span>
            <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span>
            <span class="n">edge_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="n">remove_edge</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.bfs_tree"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.bfs_tree">[docs]</a>    <span class="k">def</span> <span class="nf">bfs_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;BFS tree from the graph to all other reachable graphs.&quot;&quot;&quot;</span>
        <span class="n">bfs_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">current_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">bfs_result</span> <span class="o">+=</span> <span class="n">current_level</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_level</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">next_level</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">current_level</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                    <span class="n">next_level</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">bfs_result</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_level</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">bfs_result</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="n">current_level</span> <span class="o">=</span> <span class="n">next_level</span>
            <span class="n">bfs_result</span> <span class="o">+=</span> <span class="n">next_level</span>

        <span class="k">return</span> <span class="n">bfs_result</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.shortest_path"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.shortest_path">[docs]</a>    <span class="k">def</span> <span class="nf">shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shortest path from &#39;source&#39; to &#39;target&#39;.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">shortest_path_query</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">single</span><span class="p">()[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.copy_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.copy_graph">[docs]</a>    <span class="k">def</span> <span class="nf">copy_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">,</span> <span class="n">attach_graphs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Create a copy of a graph in a hierarchy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_graph_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HierarchyError</span><span class="p">(</span>
                <span class="s2">&quot;Graph with id &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists in the hierarchy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">new_graph_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_empty_graph</span><span class="p">(</span><span class="n">new_graph_id</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_graph_attrs</span><span class="p">(</span><span class="n">graph_id</span><span class="p">))</span>
        <span class="n">copy_nodes_q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">) CREATE (n1:</span><span class="si">{}</span><span class="s2">) SET n1=n</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">)</span>
            <span class="c1"># &quot;SET n1.oldId = n.id, n1.id = toString(id(n1))\n&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">copy_nodes_q</span><span class="p">)</span>
        <span class="n">copy_edges_q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">)-[r:</span><span class="si">{}</span><span class="s2">]-&gt;(m:</span><span class="si">{}</span><span class="s2">), (n1:</span><span class="si">{}</span><span class="s2">), (m1:</span><span class="si">{}</span><span class="s2">) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">graph_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_edge_label</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span>
                <span class="n">new_graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">)</span> <span class="o">+</span>
            <span class="s2">&quot;WHERE n1.id=n.id AND m1.id=m.id </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;MERGE (n1)-[r1:</span><span class="si">{}</span><span class="s2">]-&gt;(m1) SET r1=r</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_graph_edge_label</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">copy_edges_q</span><span class="p">)</span>
        <span class="c1"># copy all typings</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">attach_graphs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span><span class="n">new_graph_id</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacent_relations</span><span class="p">(</span><span class="n">graph_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_relation</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.relabel_graph_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.relabel_graph_node">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_graph_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename a node in a graph of the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">relabel_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.relabel_graph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.relabel_graph">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel a graph in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_id : hashable</span>
<span class="sd">            Id of the graph to relabel</span>
<span class="sd">        new_graph_id : hashable</span>
<span class="sd">            New graph id to assign to this graph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_graph_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ReGraphError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot relabel &#39;</span><span class="si">{}</span><span class="s2">&#39; to &#39;</span><span class="si">{}</span><span class="s2">&#39;, &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;already exists in the hierarchy&quot;</span><span class="p">)</span>
        <span class="c1"># Change labels of data nodes</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span> <span class="o">+</span>
            <span class="s2">&quot;SET n:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_graph_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Relabel node in the skeleton</span>
        <span class="n">skeleton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span>
        <span class="n">skeleton</span><span class="o">.</span><span class="n">relabel_node</span><span class="p">(</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">new_graph_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.relabel_graphs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.relabel_graphs">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel graphs in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mapping: dict</span>
<span class="sd">            A dictionary with keys being old graph ids and their values</span>
<span class="sd">            being new id&#39;s of the respective graphs.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ReGraphError</span>
<span class="sd">            If new id&#39;s do not define a set of distinct graph id&#39;s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Relabel nodes in the skeleton</span>
        <span class="n">skeleton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">)</span>
        <span class="n">skeleton</span><span class="o">.</span><span class="n">relabel_nodes</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>

        <span class="n">temp_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Relabeling of the nodes: if at some point new ID conflicts</span>
        <span class="c1"># with already existing ID - assign temp ID</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_new_node_id</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">temp_names</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;SET n:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># Relabeling the nodes with the temp ID to their new IDs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">temp_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (n:</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;SET n:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_update_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the mapping dictionary from source to target.&quot;&quot;&quot;</span>
        <span class="n">old_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">typing_to_update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">typing_to_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;MATCH (s:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})-[r:</span><span class="si">{}</span><span class="s2">]-&gt;(t:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}}), &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">old_mapping</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span>
                <span class="s2">&quot;(new_t:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;DELETE r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;MERGE (s)-[:</span><span class="si">{}</span><span class="s2">]-&gt;(new_t)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">new_typing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">typing_to_update</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_typing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;MATCH (s:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}}), (new_t:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;MERGE (s)-[:</span><span class="si">{}</span><span class="s2">]-&gt;(new_t)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the relation dictionaries (left and right).&quot;&quot;&quot;</span>
        <span class="n">old_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relation</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">relations_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">old_relation</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">old_relation</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relation</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">])</span>

        <span class="n">relation_to_remove</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">relation</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relation</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old_relation</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">relations_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (s:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}}), (t:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}}) </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">left</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;MERGE (s)-[:</span><span class="si">{}</span><span class="s2">]-&gt;(new_t)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_relation_label</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">relation_to_remove</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MATCH (s:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})-[r:</span><span class="si">{}</span><span class="s2">]-(t:</span><span class="si">{}</span><span class="s2"> {{id: &#39;</span><span class="si">{}</span><span class="s2">&#39;}})</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">left</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_relation_label</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;DELETE r</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_rule_liftings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">p_typing</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_rule_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># Implementation of the Neo4jHierarchy-specific methods</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">graph_label</span><span class="o">=</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span>
                 <span class="n">typing_label</span><span class="o">=</span><span class="s2">&quot;homomorphism&quot;</span><span class="p">,</span>
                 <span class="n">relation_label</span><span class="o">=</span><span class="s2">&quot;binaryRelation&quot;</span><span class="p">,</span>
                 <span class="n">graph_edge_label</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span>
                 <span class="n">graph_typing_label</span><span class="o">=</span><span class="s2">&quot;typing&quot;</span><span class="p">,</span>
                 <span class="n">graph_relation_label</span><span class="o">=</span><span class="s2">&quot;relation&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize driver.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        uri : str, optional</span>
<span class="sd">            Uri for Neo4j database connection</span>
<span class="sd">        user : str, optional</span>
<span class="sd">            Username for Neo4j database connection</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            Password for Neo4j database connection</span>
<span class="sd">        driver : neo4j.v1.direct.DirectDriver, optional</span>
<span class="sd">            Driver providing connection to a Neo4j database.</span>
<span class="sd">        graph_label : str, optional</span>
<span class="sd">            Label to use for skeleton nodes representing graphs.</span>
<span class="sd">        typing_label : str, optional</span>
<span class="sd">            Relation type to use for skeleton edges</span>
<span class="sd">            representing homomorphisms.</span>
<span class="sd">        relation_label : str, optional</span>
<span class="sd">            Relation type to use for skeleton edges</span>
<span class="sd">            representing relations.</span>
<span class="sd">        graph_edge_label : str, optional</span>
<span class="sd">            Relation type to use for all graph edges.</span>
<span class="sd">        graph_typing_label : str, optional</span>
<span class="sd">            Relation type to use for edges encoding homomorphisms.</span>
<span class="sd">        graph_relation_label : str, optional</span>
<span class="sd">            Relation type to use for edges encoding relations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The following idea is cool but it&#39;s not so easy:</span>
        <span class="c1"># as we have two types of nodes in the hierarchy:</span>
        <span class="c1"># graphs and rules, as well as two types of edges:</span>
        <span class="c1"># homomorphisms and relations, and so far Neo4jGraph</span>
        <span class="c1"># supports only a single label for nodes and for edges</span>
        <span class="c1"># Neo4jGraph.__init__(</span>
        <span class="c1">#     self, uri=uri, user=user, password=password,</span>
        <span class="c1">#     node_label=&quot;hierarchyNode&quot;,</span>
        <span class="c1">#     edge_label=&quot;hierarchyEdge&quot;)</span>

        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span>
                <span class="n">uri</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">driver</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span> <span class="o">=</span> <span class="n">graph_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span> <span class="o">=</span> <span class="n">typing_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span> <span class="o">=</span> <span class="n">relation_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_edge_label</span> <span class="o">=</span> <span class="n">graph_edge_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span> <span class="o">=</span> <span class="n">graph_typing_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_relation_label</span> <span class="o">=</span> <span class="n">graph_relation_label</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;CREATE &quot;</span> <span class="o">+</span> <span class="n">constraint_query</span><span class="p">(</span>
                <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Neo4jHierarchy.load"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">hierarchy</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span>
                    <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">,</span>
                    <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hierarchy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReGraphError</span><span class="p">(</span><span class="s2">&quot;File &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.from_json"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create hierarchy object from JSON representation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        uri : str, optional</span>
<span class="sd">            Uri for Neo4j database connection</span>
<span class="sd">        user : str, optional</span>
<span class="sd">            Username for Neo4j database connection</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            Password for Neo4j database connection</span>
<span class="sd">        driver : neo4j.v1.direct.DirectDriver, optional</span>
<span class="sd">            DB driver object</span>
<span class="sd">        json_data : dict, optional</span>
<span class="sd">            JSON-like dict containing representation of a hierarchy</span>
<span class="sd">        ignore : dict, optional</span>
<span class="sd">            Dictionary containing components to ignore in the process</span>
<span class="sd">            of converting from JSON, dictionary should respect the</span>
<span class="sd">            following format:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;graphs&quot;: &lt;collection of ids of graphs to ignore&gt;,</span>
<span class="sd">                &quot;rules&quot;: &lt;collection of ids of rules to ignore&gt;,</span>
<span class="sd">                &quot;typing&quot;: &lt;collection of tuples containing typing</span>
<span class="sd">                    edges to ignore&gt;,</span>
<span class="sd">                &quot;rule_typing&quot;: &lt;collection of tuples containing rule</span>
<span class="sd">                    typing edges to ignore&gt;&gt;,</span>
<span class="sd">                &quot;relations&quot;: &lt;collection of tuples containing</span>
<span class="sd">                    relations to ignore&gt;,</span>
<span class="sd">            }</span>
<span class="sd">        directed : bool, optional</span>
<span class="sd">            True if graphs from JSON representation should be loaded as</span>
<span class="sd">            directed graphs, False otherwise, default value -- True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hierarchy : regraph.hierarchy.Hierarchy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hierarchy</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clear</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">hierarchy</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="c1"># add graphs</span>
        <span class="k">for</span> <span class="n">graph_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;graphs&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph_from_json</span><span class="p">(</span>
                    <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># add typing</span>
        <span class="k">for</span> <span class="n">typing_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;typing&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span> <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">typing_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span>
                    <span class="n">typing_data</span><span class="p">[</span><span class="s2">&quot;mapping&quot;</span><span class="p">],</span>
                    <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># add relations</span>
        <span class="k">for</span> <span class="n">relation_data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]:</span>
            <span class="n">from_g</span> <span class="o">=</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
            <span class="n">to_g</span> <span class="o">=</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>\
               <span class="s2">&quot;relations&quot;</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span>\
               <span class="p">((</span><span class="n">from_g</span><span class="p">,</span> <span class="n">to_g</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">to_g</span><span class="p">,</span> <span class="n">from_g</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attrs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">relation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs_from_json</span><span class="p">(</span><span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">from_g</span><span class="p">,</span> <span class="n">to_g</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">relations</span><span class="p">():</span>
                    <span class="n">hierarchy</span><span class="o">.</span><span class="n">add_relation</span><span class="p">(</span>
                        <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span>
                        <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">],</span>
                        <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">relation_data</span><span class="p">[</span><span class="s2">&quot;rel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                        <span class="n">attrs</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">hierarchy</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.close"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close connection to the database.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Neo4jHierarchy.execute"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.Neo4jHierarchy.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a Cypher query.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the hierarchy.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">clear_graph</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># self.drop_all_constraints()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;MATCH (n) DETACH DELETE n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_all_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drop all the constraints on the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;CALL db.constraints&quot;</span><span class="p">):</span>
                <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;DROP &quot;</span> <span class="o">+</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_access_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">edge_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access a graph of the hierarchy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edge_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_label</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Neo4jGraph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="p">,</span>
            <span class="n">node_label</span><span class="o">=</span><span class="n">graph_id</span><span class="p">,</span> <span class="n">edge_label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="TypedNeo4jGraph"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph">[docs]</a><span class="k">class</span> <span class="nc">TypedNeo4jGraph</span><span class="p">(</span><span class="n">Neo4jHierarchy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class implementing two level hiearchy.</span>

<span class="sd">    This class encapsulates neo4j.v1.GraphDatabase object.</span>
<span class="sd">    It provides an interface for accessing typed graphs</span>
<span class="sd">    accommodated in the Neo4j DB. Our system is assumed to</span>
<span class="sd">    consist of two graphs (the data graph) and (the schema graph)</span>
<span class="sd">    connected with a graph homomorphisms (defining typing of</span>
<span class="sd">    the data graph by the schema graph).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _driver :  neo4j.v1.GraphDatabase</span>
<span class="sd">        Driver providing connection to a Neo4j database</span>
<span class="sd">    _graph_label : str</span>
<span class="sd">    _typing_label : str</span>
<span class="sd">    _graph_edge_label : str</span>
<span class="sd">    _graph_typing_label : str</span>
<span class="sd">    _schema_node_label : str</span>
<span class="sd">        Label of nodes inducing the schema graph.</span>
<span class="sd">    _data_node_label : str</span>

<span class="sd">    Top level represents a data instance, while bottom level represents</span>
<span class="sd">    a graphical schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">schema_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">graph_label</span><span class="o">=</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span>
                 <span class="n">typing_label</span><span class="o">=</span><span class="s2">&quot;homomorphism&quot;</span><span class="p">,</span>
                 <span class="n">graph_edge_label</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span>
                 <span class="n">graph_typing_label</span><span class="o">=</span><span class="s2">&quot;typing&quot;</span><span class="p">,</span>
                 <span class="n">schema_node_label</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">data_node_label</span><span class="o">=</span><span class="s2">&quot;node&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize driver.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        uri : str, optional</span>
<span class="sd">            Uri of bolt listener, for example &#39;bolt://127.0.0.1:7687&#39;</span>
<span class="sd">        user : str, optional</span>
<span class="sd">            Neo4j database user id</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            Neo4j database password</span>
<span class="sd">        driver : neo4j.v1.direct.DirectDriver, optional</span>
<span class="sd">        graph_label : str, optional</span>
<span class="sd">            Label to use for skeleton nodes representing graphs.</span>
<span class="sd">        typing_label : str, optional</span>
<span class="sd">            Relation type to use for skeleton edges</span>
<span class="sd">            representing homomorphisms.</span>
<span class="sd">        graph_edge_label : str, optional</span>
<span class="sd">            Relation type to use for all graph edges.</span>
<span class="sd">        graph_typing_label : str, optional</span>
<span class="sd">            Relation type to use for edges encoding homomorphisms.</span>
<span class="sd">        schema_graph : dict, optional</span>
<span class="sd">            Schema graph to initialize the TypedGraph in JSON representation:</span>
<span class="sd">            {&quot;nodes&quot;: &lt;networkx_like_nodes&gt;, &quot;edges&quot;: &lt;networkx_like_edges&gt;}.</span>
<span class="sd">            By default is empty.</span>
<span class="sd">        data_graph : dict, optional</span>
<span class="sd">            Data graph to initialize the TypedGraph in JSON representation:</span>
<span class="sd">            {&quot;nodes&quot;: &lt;networkx_like_nodes&gt;, &quot;edges&quot;: &lt;networkx_like_edges&gt;}.</span>
<span class="sd">            By default is empty.</span>
<span class="sd">        typing : dict, optional</span>
<span class="sd">            Dictionary contaning typing of data nodes by schema nodes.</span>
<span class="sd">            By default is empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span>
            <span class="n">uri</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">clear</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_label</span> <span class="o">=</span> <span class="s2">&quot;graph&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_typing_label</span> <span class="o">=</span> <span class="s2">&quot;homomorphism&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relation_label</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_edge_label</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_typing_label</span> <span class="o">=</span> <span class="s2">&quot;typing&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_relation_label</span> <span class="o">=</span> <span class="s2">&quot;relation&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>

        <span class="c1"># create data/schema nodes</span>
        <span class="k">if</span> <span class="n">schema_graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_graph_from_data</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">,</span>
                    <span class="n">schema_graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">],</span>
                    <span class="n">schema_graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The database already contains an instance of the &quot;</span>
                    <span class="s2">&quot;schema graph, ignoring provided node and edge list&quot;</span><span class="p">,</span>
                    <span class="n">ReGraphWarning</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">data_graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphs</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_graph_from_data</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span>
                    <span class="n">data_graph</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">],</span>
                    <span class="n">data_graph</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The database already contains an instance of the &quot;</span>
                    <span class="s2">&quot;data graph, ignoring provided node and edge list&quot;</span><span class="p">,</span>
                    <span class="n">ReGraphWarning</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">typing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typings</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">,</span> <span class="n">typing</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The database already contains a typing of the &quot;</span>
                    <span class="s2">&quot;data by the schema, ignoring provided typing&quot;</span><span class="p">,</span>
                    <span class="n">ReGraphWarning</span>
                <span class="p">)</span>

<div class="viewcode-block" id="TypedNeo4jGraph.get_instances"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all the instances of the schema node.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">(),</span> <span class="n">schema_node</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.find_data_matching"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.find_data_matching">[docs]</a>    <span class="k">def</span> <span class="nf">find_data_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find matching of a pattern in the data graph.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pattern : Graph object</span>
<span class="sd">            A pattern to match</span>
<span class="sd">        pattern_typing : dict</span>
<span class="sd">            A dictionary that specifies a typing of a pattern,</span>
<span class="sd">            keys of the dictionary -- graph id that types a pattern, this graph</span>
<span class="sd">            should be among parents of the `graph_id` graph;</span>
<span class="sd">            values are mappings of nodes from pattern to the typing graph;</span>
<span class="sd">        nodes : iterable</span>
<span class="sd">            Subset of nodes where matching should be performed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        instances : list of dict</span>
<span class="sd">            List of matched instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_typing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pattern_typing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema_typing</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">:</span> <span class="n">pattern_typing</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_matching</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span>
            <span class="n">pattern</span><span class="p">,</span>
            <span class="n">pattern_typing</span><span class="o">=</span><span class="n">schema_typing</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.find_schema_matching"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.find_schema_matching">[docs]</a>    <span class="k">def</span> <span class="nf">find_schema_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find matching of a pattern in the schema graph.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pattern : Graph object</span>
<span class="sd">            A pattern to match</span>
<span class="sd">        pattern_typing : dict</span>
<span class="sd">            A dictionary that specifies a typing of a pattern,</span>
<span class="sd">            keys of the dictionary -- graph id that types a pattern, this graph</span>
<span class="sd">            should be among parents of the `graph_id` graph;</span>
<span class="sd">            values are mappings of nodes from pattern to the typing graph;</span>
<span class="sd">        nodes : iterable</span>
<span class="sd">            Subset of nodes where matching should be performed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        instances : list of dict</span>
<span class="sd">            List of matched instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_matching</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">,</span>
            <span class="n">pattern</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.rewrite_data"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.rewrite_data">[docs]</a>    <span class="k">def</span> <span class="nf">rewrite_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
                     <span class="n">rhs_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rewrite the data graph.</span>

<span class="sd">         Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule : regraph.rule.Rule</span>
<span class="sd">            Rule object to apply</span>
<span class="sd">        instance : dict, optional</span>
<span class="sd">            Dictionary containing an instance of the lhs of the rule in</span>
<span class="sd">            the data graph, by default, tries to construct the</span>
<span class="sd">            identity morphism of the nodes of the pattern</span>
<span class="sd">        rhs_typing : dict, optional</span>
<span class="sd">            Dictionary containing typing of the rhs by the schema.</span>
<span class="sd">        strict : bool, optional</span>
<span class="sd">            Rewriting is strict when propagation down is not allowed</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If the graph is not in the database</span>
<span class="sd">        RewritingError</span>
<span class="sd">            If the provided p and rhs typing are inconsistent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rhs_typing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rhs_typing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span>
            <span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">rhs_typing</span><span class="o">=</span><span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">:</span> <span class="n">rhs_typing</span>
            <span class="p">},</span>
            <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.rewrite_schema"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.rewrite_schema">[docs]</a>    <span class="k">def</span> <span class="nf">rewrite_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">data_typing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rewrite the schema graph.</span>

<span class="sd">         Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule : regraph.rule.Rule</span>
<span class="sd">            Rule object to apply</span>
<span class="sd">        instance : dict, optional</span>
<span class="sd">            Dictionary containing an instance of the lhs of the rule in</span>
<span class="sd">            the schema graph, by default, tries to construct the</span>
<span class="sd">            identity morphism of the nodes of the pattern</span>
<span class="sd">        data_typing : dict, optional</span>
<span class="sd">            Dictionary containing typing of data by the</span>
<span class="sd">            interface of the rule.</span>
<span class="sd">        strict : bool, optional</span>
<span class="sd">            Rewriting is strict when propagation down is not allowed</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        HierarchyError</span>
<span class="sd">            If the graph is not in the database</span>
<span class="sd">        RewritingError</span>
<span class="sd">            If the provided p and rhs typing are inconsistent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p_typing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">data_typing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_typing</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">:</span> <span class="n">data_typing</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">,</span>
            <span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">p_typing</span><span class="o">=</span><span class="n">p_typing</span><span class="p">,</span>
            <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.relabel_schema_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.relabel_schema_node">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_schema_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel a node in the schema.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relabel_graph_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.relabel_data_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.relabel_data_node">[docs]</a>    <span class="k">def</span> <span class="nf">relabel_data_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel a node in the data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relabel_graph_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">new_node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_data"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the data graph object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_schema"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_schema">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the schema graph object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_data_nodes"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_data_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get to nodes of the data.&quot;&quot;&quot;</span>
        <span class="n">data_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data_g</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_data_edges"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_data_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the edges of the data.&quot;&quot;&quot;</span>
        <span class="n">data_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data_g</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_schema_nodes"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_schema_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the nodes of the schema.&quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">schema</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_schema_edges"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_schema_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the edges of the schema.&quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">schema</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_data_typing"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_data_typing">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_typing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the typing of the data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_typing</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_node_type"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_node_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_node_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the type of a node in the data.&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">]</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_data_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_data_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the attributes of a data node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.get_schema_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.get_schema_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the attributes of a schema node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span></div>

    <span class="c1"># Set of utils for type-respecting transformations</span>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_data_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_data_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_data_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a data node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_data_edge"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_data_edge">[docs]</a>    <span class="k">def</span> <span class="nf">remove_data_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a data edge.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_node_label</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_data_node_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_data_node_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">remove_data_node_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the attributes of a data node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_node_attrs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_data_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_data_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">typing</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a data node typed by the specified schema node.&quot;&quot;&quot;</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_transform</span><span class="p">(</span><span class="n">NXGraph</span><span class="p">())</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">inject_add_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">rhs_typing</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_id</span><span class="p">:</span> <span class="n">typing</span><span class="p">}</span>
        <span class="n">rhs_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_data</span><span class="p">(</span>
            <span class="n">rule</span><span class="p">,</span> <span class="p">{},</span> <span class="n">rhs_typing</span><span class="o">=</span><span class="n">rhs_typing</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rhs_instance</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_data_edge"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_data_edge">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a data edge.&quot;&quot;&quot;</span>
        <span class="n">schema_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">schema_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot add an edge &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;edge &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; is not allowed by the schema&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">schema_attrs</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">schema_attrs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot add attributes </span><span class="si">{}</span><span class="s2"> to &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">attrs</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;the typing schema edge &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; does not allow &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;these attributes (allowed </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_attrs</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_data_node_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_data_node_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_node_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the attributes to a data node.&quot;&quot;&quot;</span>
        <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">schema_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">schema_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_node</span><span class="p">(</span><span class="n">schema_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">schema_attrs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot add attributes </span><span class="si">{}</span><span class="s2"> to &#39;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">attrs</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;the typing schema node &#39;</span><span class="si">{}</span><span class="s2">&#39; does not allow &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_node</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;these attributes (allowed </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_attrs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node_attrs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_data_edge_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_data_edge_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_edge_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a data edge.&quot;&quot;&quot;</span>
        <span class="n">schema_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">schema_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>

        <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">schema_attrs</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">schema_attrs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot add attributes </span><span class="si">{}</span><span class="s2"> to &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">attrs</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;the typing schema edge &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; does not allow &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schema_s</span><span class="p">,</span> <span class="n">schema_t</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;these attributes (allowed </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_attrs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">add_edge_attrs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.merge_data_nodes"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.merge_data_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">merge_data_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge data nodes.&quot;&quot;&quot;</span>
        <span class="n">data_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">()</span>
        <span class="n">schema_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
            <span class="n">data_typing</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node_list</span>
        <span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot merge the data nodes </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;of different types (i.e. </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_nodes</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">NXGraph</span><span class="p">()</span>
        <span class="n">pattern</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_transform</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">merged_node</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">inject_merge_nodes</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span>
        <span class="n">rhs_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_data</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rhs_instance</span><span class="p">[</span><span class="n">merged_node</span><span class="p">]</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_schema_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_schema_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_schema_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a schema node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_schema_edge"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_schema_edge">[docs]</a>    <span class="k">def</span> <span class="nf">add_schema_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a schema node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.add_schema_node_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.add_schema_node_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">add_schema_node_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the attributes of a schema node.&quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_node_label</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_node_attrs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_schema_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_schema_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_schema_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a schema node.&quot;&quot;&quot;</span>
        <span class="n">data_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">()</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot remove &#39;</span><span class="si">{}</span><span class="s2">&#39; from the schema: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">node_id</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; has instances in the data (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">node_id</span><span class="p">,</span> <span class="n">instances</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_schema_node_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_schema_node_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">remove_schema_node_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a schema node.&quot;&quot;&quot;</span>
        <span class="n">data_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">()</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
                <span class="n">instance_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_node</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">valid_attributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">instance_attrs</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot remove attributes </span><span class="si">{}</span><span class="s2"> from &#39;</span><span class="si">{}</span><span class="s2">&#39; in the schema: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">attrs</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot;the instance &#39;</span><span class="si">{}</span><span class="s2">&#39; in the data has attributes </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">instance</span><span class="p">,</span> <span class="n">instance_attrs</span><span class="p">))</span>

        <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_node_attrs</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_schema_edge"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_schema_edge">[docs]</a>    <span class="k">def</span> <span class="nf">remove_schema_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a schema node.&quot;&quot;&quot;</span>
        <span class="n">data_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">()</span>
        <span class="n">instances_s</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">instances_t</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">instances_s</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instances_t</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot remove &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; from the schema: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; has an instance in the data (&#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39;&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.remove_schema_edge_attrs"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.remove_schema_edge_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">remove_schema_edge_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a schema node.&quot;&quot;&quot;</span>
        <span class="n">data_typing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_typing</span><span class="p">()</span>
        <span class="n">instances_s</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">instances_t</span> <span class="o">=</span> <span class="n">keys_by_value</span><span class="p">(</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">normalize_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">instances_s</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instances_t</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                    <span class="n">data_attrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">valid_attributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">data_attrs</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">RewritingError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot remove attributes </span><span class="si">{}</span><span class="s2"> from &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">attrs</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;in the schema: the instance &#39;</span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;in the data has attributes </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">data_attrs</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_edge_attrs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TypedNeo4jGraph.clone_schema_node"><a class="viewcode-back" href="../../../../neo4jhierarchies.html#regraph.backends.neo4j.hierarchies.TypedNeo4jGraph.clone_schema_node">[docs]</a>    <span class="k">def</span> <span class="nf">clone_schema_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">data_typing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clone a schema node.&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">NXGraph</span><span class="p">()</span>
        <span class="n">pattern</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_transform</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">rhs_clone</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">inject_clone_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">rhs_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_schema</span><span class="p">(</span>
            <span class="n">rule</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_typing</span><span class="o">=</span><span class="n">data_typing</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rhs_instance</span><span class="p">[</span><span class="n">rhs_clone</span><span class="p">]</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ReGraph</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Eugenia Oshurko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>