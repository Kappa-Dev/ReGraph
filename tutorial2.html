
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorial &#8212; ReGraph 1.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><dl class="first docutils">
<dt><a class="reference internal" href="tutorial1.html#tutorial-part1"><span class="std std-ref">Tutorial: part 1</span></a></dt>
<dd><ul class="first last">
<li><a class="reference internal" href="tutorial1.html#installation"><span class="std std-ref">Installation</span></a></li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="tutorial1.html#simple-rewriting"><span class="std std-ref">Simple graph rewriting</span></a></dt>
<dd><ul class="first last">
<li><a class="reference internal" href="tutorial1.html#graph-creation"><span class="std std-ref">Primitive graph transformations</span></a></li>
<li><a class="reference internal" href="tutorial1.html#advanced-attributes"><span class="std std-ref">Advanced attributes</span></a></li>
<li><a class="reference internal" href="tutorial1.html#rewiting-rules"><span class="std std-ref">Rewriting rules</span></a></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#tutorial-part2"><span class="std std-ref">Tutorial: part 2</span></a></dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt><a class="reference internal" href="#hierarchy-tutorial"><span class="std std-ref">Hierarchy</span></a></dt>
<dd><ul class="first last">
<li><a class="reference internal" href="#hierarchy-creation"><span class="std std-ref">Hierarchy creation</span></a></li>
<li><a class="reference internal" href="#rewriting-in-hierarchy"><span class="std std-ref">Rewriting in the hierarchy</span></a></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="tutorial-part-2">
<span id="tutorial-part2"></span><h1>Tutorial: part 2<a class="headerlink" href="#tutorial-part-2" title="Permalink to this headline">¶</a></h1>
<p>If you missed the part of the ReGraph tutorial about primitive graph transformations, advanced graph attributes and rewriting rules, go back to <a class="reference internal" href="tutorial1.html#tutorial-part1"><span class="std std-ref">Tutorial: part 1</span></a>.</p>
<div class="section" id="hierarchy">
<span id="hierarchy-tutorial"></span><h2>Hierarchy<a class="headerlink" href="#hierarchy" title="Permalink to this headline">¶</a></h2>
<p>A graph hierarchy is a directed acyclic graph where nodes are graphs with attributes and edges are
homomorphisms representing graph typing in the system. This construction provides means
for mathematically robust procedures of propagation of changes (expressed through graph rewriting
rules) on any level of the hierarchy, up to all the graphs which are transitively typed by the graph
subject to rewriting. In the following section we give a simple example of such hierarchy and its
functionality implemented in ReGraph (for more details see the module <a class="reference internal" href="hierarchy.html#hierarchy"><span class="std std-ref">Hierarchy</span></a>).</p>
<div class="section" id="hierarchy-creation">
<span id="id1"></span><h3>Hierarchy creation<a class="headerlink" href="#hierarchy-creation" title="Permalink to this headline">¶</a></h3>
<p>Create an empty hierarchy and add graphs to the hierarchy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">regraph</span> <span class="k">import</span> <span class="n">Hierarchy</span><span class="p">,</span> <span class="n">plot_graph</span><span class="p">,</span> <span class="n">primitives</span>


<span class="n">hierarchy</span> <span class="o">=</span> <span class="n">Hierarchy</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>
    <span class="p">])</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">g</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;protein&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span>
     <span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">g</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;protein&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="s2">&quot;protein&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;protein&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">),</span>
    <span class="p">])</span>

<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex1_meta_meta_model.png" src="_images/ex1_meta_meta_model.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex1_meta_model.png" src="_images/ex1_meta_model.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graphs</span><span class="p">()</span>
<span class="go">[&#39;T&#39;, &#39;G&#39;]</span>
</pre></div>
</div>
<p>Add typing of the graph <cite>G</cite> by <cite>T</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;protein&quot;</span><span class="p">:</span> <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="s2">&quot;action&quot;</span>
<span class="p">}</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">][</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
<span class="go">{&#39;activity&#39;: &#39;state&#39;, &#39;mod&#39;: &#39;action&#39;, &#39;protein&#39;: &#39;agent&#39;, &#39;region&#39;: &#39;agent&#39;}</span>
</pre></div>
</div>
<p>You can check typing of a particular node of a graph, for example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">node_type</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">)</span>
<span class="go">{&#39;T&#39;: &#39;agent&#39;}</span>
</pre></div>
</div>
<p>Create another graph, let’s call it <cite>model</cite>, and type it by <cite>G</cite></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;B_activity&quot;</span><span class="p">,</span>
     <span class="s2">&quot;A_activity&quot;</span><span class="p">,</span> <span class="s2">&quot;activation&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;activation&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;activation&quot;</span><span class="p">,</span> <span class="s2">&quot;B_activity&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;B_activity&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;activation&quot;</span><span class="p">,</span> <span class="s2">&quot;A_activity&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;A_activity&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

<span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;protein&quot;</span><span class="p">,</span>
    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;protein&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B_activity&quot;</span><span class="p">:</span> <span class="s2">&quot;activity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;A_activity&quot;</span><span class="p">:</span> <span class="s2">&quot;activity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="s2">&quot;mod&quot;</span>
<span class="p">}</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

<span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex1_model.png" src="_images/ex1_model.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typings</span><span class="p">()</span>
<span class="go">[(&#39;G&#39;, &#39;T&#39;), (&#39;model&#39;, &#39;G&#39;)]</span>
</pre></div>
</div>
<p>Remove a node from the hierarchy and reconnect its predecessors with its successors:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typings</span><span class="p">()</span>
<span class="go">[(&#39;model&#39;, &#39;T&#39;)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;agent&#39;,</span>
<span class="go"> &#39;B&#39;: &#39;agent&#39;,</span>
<span class="go"> &#39;B_activity&#39;: &#39;state&#39;,</span>
<span class="go"> &#39;A_activity&#39;: &#39;state&#39;,</span>
<span class="go"> &#39;R&#39;: &#39;agent&#39;,</span>
<span class="go"> &#39;activation&#39;: &#39;action&#39;}</span>
</pre></div>
</div>
<p>Graph hierarchy allows to accommodate binary symmetric relations on graphs.
Consider the following graph:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">catalysis</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">catalysis</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;enzyme&quot;</span><span class="p">,</span> <span class="s2">&quot;substrate&quot;</span><span class="p">,</span>
     <span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;mod_state&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">catalysis</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;enzyme&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;mod_state&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;mod_state&quot;</span><span class="p">,</span> <span class="s2">&quot;substrate&quot;</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;catalysis&quot;</span><span class="p">,</span> <span class="n">catalysis</span><span class="p">)</span>

<span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;catalysis&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex1_catalysis.png" src="_images/ex1_catalysis.png" />
<p>Create a relation between graph <cite>model</cite> and graph <cite>catalysis</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">relation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;enzyme&quot;</span><span class="p">,</span> <span class="s2">&quot;substrate&quot;</span><span class="p">},</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;substrate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B_activity&quot;</span><span class="p">:</span> <span class="s2">&quot;mod_state&quot;</span><span class="p">,</span>
    <span class="s2">&quot;A_activity&quot;</span><span class="p">:</span> <span class="s2">&quot;mod_state&quot;</span><span class="p">,</span>
    <span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="s2">&quot;mod&quot;</span>
<span class="p">}</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_relation</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;catalysis&#39;</span><span class="p">,</span> <span class="n">relation</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that in a relation between two graphs a node from one graph can be related to a set of nodes
from another graph (in our example node ‘A’ in the graph <cite>model</cite> is related to both
‘enzyme’ and ‘substrate’ from the graph <cite>catalysis</cite>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;catalysis&#39;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: {&#39;enzyme&#39;, &#39;substrate&#39;},</span>
<span class="go"> &#39;A_activity&#39;: {&#39;mod_state&#39;},</span>
<span class="go"> &#39;B&#39;: {&#39;substrate&#39;},</span>
<span class="go"> &#39;B_activity&#39;: {&#39;mod_state&#39;},</span>
<span class="go"> &#39;activation&#39;: {&#39;mod&#39;}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">relation</span><span class="p">[</span><span class="s1">&#39;catalysis&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="go">{&#39;enzyme&#39;: {&#39;A&#39;},</span>
<span class="go"> &#39;mod&#39;: {&#39;activation&#39;},</span>
<span class="go"> &#39;mod_state&#39;: {&#39;A_activity&#39;, &#39;B_activity&#39;},</span>
<span class="go"> &#39;substrate&#39;: {&#39;A&#39;, &#39;B&#39;}}</span>
</pre></div>
</div>
<p>This example can be found in the following <a class="reference download internal" href="_downloads/tutorial2_ex1.py" download=""><code class="xref download docutils literal"><span class="pre">script</span></code></a>.</p>
</div>
<div class="section" id="rewriting-in-the-hierarchy">
<span id="rewriting-in-hierarchy"></span><h3>Rewriting in the hierarchy<a class="headerlink" href="#rewriting-in-the-hierarchy" title="Permalink to this headline">¶</a></h3>
<p>This section of the tutorial covers rewriting in a graph hierarchy. Rewriting a single graph in
a hierarchy triggers a set of updates to other graphs and homomorphisms. Here we give a simple example and
illustrate a usecase of such rewriting and how it can be peformed using ReGraph.</p>
<p>First, let’s start from creating another hierarchy similar to the one in the previous example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">regraph</span> <span class="k">import</span> <span class="n">Hierarchy</span><span class="p">,</span> <span class="n">Rule</span><span class="p">,</span> <span class="n">RewritingError</span>
<span class="kn">from</span> <span class="nn">regraph</span> <span class="k">import</span> <span class="n">primitives</span>
<span class="kn">from</span> <span class="nn">regraph</span> <span class="k">import</span> <span class="n">plotting</span>


<span class="n">hierarchy</span> <span class="o">=</span> <span class="n">Hierarchy</span><span class="p">()</span>

<span class="c1"># Initialize graphs</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">colors</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">colors</span><span class="p">,</span>
    <span class="p">[(</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">)])</span>

<span class="n">mmm</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">mmm</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">])</span>

<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">mmm</span><span class="p">,</span>
    <span class="p">[(</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="s2">&quot;component&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;component&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)])</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">mm</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;residue&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">mm</span><span class="p">,</span>
    <span class="p">[(</span><span class="s2">&quot;residue&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;residue&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">)</span>
    <span class="p">])</span>

<span class="n">action_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">action_graph</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">])</span>

<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">action_graph</span><span class="p">,</span>
    <span class="p">[(</span><span class="s2">&quot;A_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;A_res_1&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">)])</span>

<span class="n">nugget_1</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span>
    <span class="n">nugget_1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">])</span>

<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
    <span class="n">nugget_1</span><span class="p">,</span>
    <span class="p">[(</span><span class="s2">&quot;A_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;A_res_1&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
     <span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">)])</span>

<span class="c1"># Add graphs to the hierarchy</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;colors&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;mmm&quot;</span><span class="p">,</span> <span class="n">mmm</span><span class="p">)</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="n">mm</span><span class="p">)</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;ag&quot;</span><span class="p">,</span> <span class="n">action_graph</span><span class="p">)</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="n">nugget_1</span><span class="p">)</span>

<span class="c1"># Add typings to the hierarchy</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;mmm&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;gene&quot;</span> <span class="p">:</span> <span class="s2">&quot;component&quot;</span><span class="p">,</span>
        <span class="s2">&quot;residue&quot;</span><span class="p">:</span> <span class="s2">&quot;component&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="s2">&quot;action&quot;</span>
    <span class="p">})</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;colors&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;gene&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;residue&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span>
    <span class="p">})</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
    <span class="s2">&quot;ag&quot;</span><span class="p">,</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;gene&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;gene&quot;</span><span class="p">,</span>
        <span class="s2">&quot;A_res_1&quot;</span><span class="p">:</span> <span class="s2">&quot;residue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mod&quot;</span> <span class="p">:</span> <span class="s2">&quot;mod&quot;</span><span class="p">,</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="s2">&quot;state&quot;</span>
    <span class="p">})</span>
<span class="n">hierarchy</span><span class="o">.</span><span class="n">add_typing</span><span class="p">(</span>
    <span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="s2">&quot;ag&quot;</span><span class="p">,</span>
    <span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nugget_1</span><span class="o">.</span><span class="n">nodes</span><span class="p">()))</span>
</pre></div>
</div>
<p>Let’s plot the graphs of the hierarchy that we’ve just created:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_colors.png" src="_images/ex2_colors.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;mmm&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_mmm.png" src="_images/ex2_mmm.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_mm.png" src="_images/ex2_mm.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_ag.png" src="_images/ex2_ag.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_n1.png" src="_images/ex2_n1.png" />
<p>Now, we would like to rewrite the graph <cite>ag</cite> with the rule
defined below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># define a rule that clones nodes</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;residue&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;residue&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">)])</span>

<span class="n">cloning_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_transform</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="n">clone_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cloning_rule</span><span class="o">.</span><span class="n">inject_clone_node</span><span class="p">(</span><span class="s2">&quot;gene&quot;</span><span class="p">)</span>
<span class="n">cloning_rule</span><span class="o">.</span><span class="n">inject_remove_edge</span><span class="p">(</span><span class="s2">&quot;residue&quot;</span><span class="p">,</span> <span class="n">clone_name</span><span class="p">)</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_rule</span><span class="p">(</span><span class="n">cloning_rule</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_rule1.png" src="_images/ex2_rule1.png" />
<p>This rule clones a node with id ‘gene’ of the pattern and removes
an edge from the node ‘residue’ to the cloned node. Define a typing
of the left-hand side of the rule and find all its matchings in <cite>ag</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">lhs_typing</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gene&quot;</span><span class="p">:</span> <span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;residue&quot;</span><span class="p">:</span> <span class="s2">&quot;residue&quot;</span><span class="p">}</span>
<span class="p">}</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">find_matching</span><span class="p">(</span>
    <span class="s2">&quot;ag&quot;</span><span class="p">,</span> <span class="n">cloning_rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_typing</span><span class="p">)</span>
<span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">plot_instance</span><span class="p">(</span>
        <span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">],</span> <span class="n">cloning_rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_ag_rule1_instance.png" src="_images/ex2_ag_rule1_instance.png" />
<p>Perform the rewriting:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">_</span><span class="p">,</span> <span class="n">rhs_instance</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="s2">&quot;ag&quot;</span><span class="p">,</span> <span class="n">cloning_rule</span><span class="p">,</span> <span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>Now, we can plot updated <cite>ag</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_instance</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">],</span> <span class="n">cloning_rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_instance</span><span class="p">,</span>
<span class="go">              parent_pos=ag_pos)</span>
</pre></div>
</div>
<img alt="_images/ex2_ag_rule1_result.png" src="_images/ex2_ag_rule1_result.png" />
<p>As the result of the rewriting of <cite>ag</cite>, the graph <cite>n1</cite> typed by <cite>ag</cite> has changes
(clones and removes were propagated to it as well):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span>
<span class="go">           title=&quot;Graph &#39;n1&#39; after rewriting with rule 1&quot;, parent_pos=n1_pos)</span>
</pre></div>
</div>
<img alt="_images/ex2_n1_rule1_result.png" src="_images/ex2_n1_rule1_result.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">][</span><span class="s2">&quot;ag&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;A1&#39;,</span>
<span class="go"> &#39;A_res_1&#39;: &#39;A_res_1&#39;,</span>
<span class="go"> &#39;p&#39;: &#39;p&#39;,</span>
<span class="go"> &#39;B&#39;: &#39;B&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;A1&#39;: &#39;A&#39;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">][</span><span class="s2">&quot;mm&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;gene&#39;,</span>
<span class="go"> &#39;A_res_1&#39;: &#39;residue&#39;,</span>
<span class="go"> &#39;p&#39;: &#39;state&#39;, &#39;B&#39;: &#39;gene&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;A1&#39;: &#39;gene&#39;}</span>
</pre></div>
</div>
<p>Now consider the following rule and its instance in <cite>n1</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">])</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">])</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;B_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">])</span>
<span class="n">primitives</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;B_res_1&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">)</span>

<span class="n">adding_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_rule</span><span class="p">(</span><span class="n">adding_rule</span><span class="p">)</span>

<span class="n">instance</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">}</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_instance</span><span class="p">(</span>
    <span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span> <span class="n">adding_rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Graph &#39;n1&#39; with the instance of a pattern highlighted&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_rule2.png" src="_images/ex2_rule2.png" />
<img alt="_images/ex2_n1_rule2_instance.png" src="_images/ex2_n1_rule2_instance.png" />
<p>As can be seen on the figures above, our rule adds three new nodes to the graph <cite>n1</cite>
(i.e., ‘B_res_1’, ‘X’, ‘Y’) and connects with an edge ‘B’ (of the initial pattern)
and ‘B_res_1’.</p>
<p>We can also define a typing for new nodes that will be created by the rule, and it can be
done by providing a typing of the right-hand side of the rule by hierarchy graphs:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rhs_typing</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;B_res_1&quot;</span><span class="p">:</span> <span class="s2">&quot;residue&quot;</span><span class="p">},</span>
    <span class="s2">&quot;mmm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;component&quot;</span><span class="p">},</span>
    <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The typing defined by this dictionary can be interpreted as follows: “graph <cite>mm</cite> types the node ‘B_res_1’ from the right-hand side with the node ‘residue’, graph <cite>mmm</cite> types the node ‘X’ as ‘component’, and graph <cite>colors</cite> types ‘Y’ as ‘red”.</p>
<p>By default rewriting in a hierarchy (implemented in the <cite>regraph.Hierarchy.rewrite</cite> method) is not strict, i.e. it is allowed to apply rewriting rules which perform <em>relaxing changes</em> to the hierarchy graphs (add nodes/edges/attrs or merge nodes). But the previously mentioned rewriting method allows to set its input argument <cite>strict=True</cite>, in which case an attempt to apply any relaxing rule will lead to an exception (<cite>regraph.RewritingError</cite>).</p>
<p>Let’s rewrite <cite>n1</cite> with the rule using defaut non-strict rewriting:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">_</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="n">adding_rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="o">=</span><span class="n">rhs_typing</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s have a look on the changes to the hierarchy that were triggered by the rewriting:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_instance</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_instance</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_n1_rule2_result_rhs_instance.png" src="_images/ex2_n1_rule2_result_rhs_instance.png" />
<p>On the figure above we can see that we successfully created new nodes in <cite>n1</cite>. Now let us
observe the changes in <cite>ag</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_ag_rule2_result.png" src="_images/ex2_ag_rule2_result.png" />
<p>As a typing by the nodes of <cite>ag</cite> of the new nodes in <cite>n1</cite> was not specified, three new respective nodes are added to <cite>ag</cite> by the rewriting procedure, so that <cite>n1</cite> becomes typed by <cite>ag</cite> as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">][</span><span class="s2">&quot;ag&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;A&#39;,</span>
<span class="go"> &#39;A_res_1&#39;: &#39;A_res_1&#39;,</span>
<span class="go"> &#39;B&#39;: &#39;B&#39;,</span>
<span class="go"> &#39;B_res_1&#39;: &#39;B_res_1&#39;,</span>
<span class="go"> &#39;X&#39;: &#39;X&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;Y&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;p&#39;: &#39;p&#39;}</span>
</pre></div>
</div>
<p>Now what about the meta-model graph <cite>mm</cite>?</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_mm_rule2_result.png" src="_images/ex2_mm_rule2_result.png" />
<p>We can see that the nodes ‘X’ and ‘Y’ where added to <cite>mm</cite> as their typing by <cite>mm</cite> was again not
specified in <cite>rhs_typing</cite>. On the contrary, the node ‘B_res_1’ was typed by the node ‘residue’
in the meta-model, which can be seen in the updated typing of <cite>ag</cite> by <cite>mm</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">][</span><span class="s2">&quot;mm&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;gene&#39;,</span>
<span class="go"> &#39;A_res_1&#39;: &#39;residue&#39;,</span>
<span class="go"> &#39;B&#39;: &#39;gene&#39;,</span>
<span class="go"> &#39;B_res_1&#39;: &#39;residue&#39;,</span>
<span class="go"> &#39;X&#39;: &#39;X&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;Y&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;p&#39;: &#39;state&#39;}</span>
</pre></div>
</div>
<p>Similarly, we can observe in the graph <cite>mmm</cite> the new node ‘Y’ added (by <cite>rhs_typing</cite> the node ‘X’ was sent to the node ‘component’ of <cite>mmm</cite>).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;mmm&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/ex2_mmm_rule2_result.png" src="_images/ex2_mmm_rule2_result.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">][</span><span class="s2">&quot;mmm&quot;</span><span class="p">]</span>
<span class="go">{&#39;X&#39;: &#39;component&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;Y&#39;,</span>
<span class="go"> &#39;gene&#39;: &#39;component&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;action&#39;,</span>
<span class="go"> &#39;residue&#39;: &#39;component&#39;,</span>
<span class="go"> &#39;state&#39;: &#39;state&#39;}</span>
</pre></div>
</div>
<p>Finally, in the graph <cite>colors</cite> the new node ‘X’ is added (again, by <cite>rhs_typing</cite> the node ‘Y’ was sent to the node ‘red’ of <cite>colors</cite>).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_static/ex2_colors_rul2_result.png" src="_static/ex2_colors_rul2_result.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">][</span><span class="s2">&quot;colors&quot;</span><span class="p">]</span>
<span class="go">{&#39;X&#39;: &#39;X&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;red&#39;,</span>
<span class="go"> &#39;gene&#39;: &#39;red&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;blue&#39;,</span>
<span class="go"> &#39;residue&#39;: &#39;red&#39;,</span>
<span class="go"> &#39;state&#39;: &#39;red&#39;}</span>
</pre></div>
</div>
<p>Now consider yet another example of a rule and its application which leads to some propagation of changes. This time consider the following rule which performs merge of some nodes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pattern</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">pattern</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">pattern</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">merging_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_transform</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="n">merging_rule</span><span class="o">.</span><span class="n">inject_remove_edge</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">merging_rule</span><span class="o">.</span><span class="n">inject_merge_nodes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">)</span>

<span class="n">plotting</span><span class="o">.</span><span class="n">plot_rule</span><span class="p">(</span><span class="n">merging_rule</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Rule 3: contains merge of nodes&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_rule3.png" src="_images/ex2_rule3.png" />
<p>We define the typings of its left-hand side and its right-hand side, and we search for
instances in the graph <cite>n1</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">lhs_typing</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;residue&quot;</span><span class="p">}}</span>
<span class="n">rhs_typing</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mmm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;hybrid&quot;</span><span class="p">:</span> <span class="s2">&quot;component&quot;</span><span class="p">}}</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">find_matching</span><span class="p">(</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="n">merging_rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_typing</span><span class="p">)</span>
<span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
    <span class="n">plotting</span><span class="o">.</span><span class="n">plot_instance</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span> <span class="n">merging_rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_n1_rule3_instance1.png" src="_images/ex2_n1_rule3_instance1.png" />
<img alt="_images/ex2_n1_rule3_instance2.png" src="_images/ex2_n1_rule3_instance2.png" />
<p>We can see that there were found exactly two instances of the left-hand side of the rule
(i.e. the gene node ‘B’ together with the residue node ‘B_res_1’ connected to it and the gene node ‘A’ together with the residue node ‘A_res_1’). Now, let’s apply the merging rule to all the instances:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
    <span class="n">hierarchy</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="n">merging_rule</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">rhs_typing</span><span class="o">=</span><span class="n">rhs_typing</span><span class="p">)</span>

<span class="n">plot_graph</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Graph &#39;n1&#39; after rewriting with rule 3&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ex2_n1_rule3_result.png" src="_images/ex2_n1_rule3_result.png" />
<p>Changes that were made to <cite>ag</cite>:</p>
<img alt="_images/ex2_ag_rule3_result.png" src="_images/ex2_ag_rule3_result.png" />
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">][</span><span class="s2">&quot;ag&quot;</span><span class="p">]</span>
<span class="go">{&#39;A&#39;: &#39;A1&#39;,</span>
<span class="go"> &#39;p&#39;: &#39;p&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;X&#39;: &#39;X&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;Y&#39;,</span>
<span class="go"> &#39;A1_A_res_1&#39;: &#39;A_res_1_A&#39;,</span>
<span class="go"> &#39;B_B_res_1&#39;: &#39;B_res_1_B&#39;}</span>
</pre></div>
</div>
<p>This is how our meta-model <cite>mm</cite> looks like after rewriting:</p>
<img alt="_images/ex2_mm_rule3_result.png" src="_images/ex2_mm_rule3_result.png" />
<p>Nodes ‘residue’ and ‘gene’ were merged in <cite>mm</cite>. Now updated typing
of <cite>ag</cite> by <cite>mm</cite> is following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;ag&quot;</span><span class="p">][</span><span class="s2">&quot;mm&quot;</span><span class="p">]</span>
<span class="go">{&#39;p&#39;: &#39;state&#39;,</span>
<span class="go"> &#39;mod&#39;: &#39;mod&#39;,</span>
<span class="go"> &#39;A1&#39;: &#39;residue_gene&#39;,</span>
<span class="go"> &#39;X&#39;: &#39;X&#39;,</span>
<span class="go"> &#39;Y&#39;: &#39;Y&#39;,</span>
<span class="go"> &#39;A_res_1_A&#39;: &#39;residue_gene&#39;,</span>
<span class="go"> &#39;B_res_1_B&#39;: &#39;residue_gene&#39;}</span>
</pre></div>
</div>
<p>The new ‘hybrid’ node (i.e. ‘residue_gene’) is typed by the node ‘component’ of <cite>mmm</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hierarchy</span><span class="o">.</span><span class="n">typing</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">][</span><span class="s2">&quot;mmm&quot;</span><span class="p">][</span><span class="s2">&quot;residue_gene&quot;</span><span class="p">]</span>
<span class="go">&#39;component&#39;</span>
</pre></div>
</div>
<p>This example can be found in the following <a class="reference download internal" href="_downloads/tutorial2_ex2.py" download=""><code class="xref download docutils literal"><span class="pre">script</span></code></a>.</p>
<div class="section" id="see-more">
<h4>See more<a class="headerlink" href="#see-more" title="Permalink to this headline">¶</a></h4>
<p>Module reference: <a class="reference internal" href="hierarchy.html#hierarchy"><span class="std std-ref">Hierarchy</span></a></p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">ReGraph</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Eugenia Oshurko, Yves-Stan Le Cornec.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/tutorial2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>